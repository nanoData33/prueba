<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Informe Clínico Comparativo</title>

<!-- Librerías -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --verde: #3d7658;
  --verde-claro: #4ba67d;
  --gris-fondo: #f8f9f8;
  --gris-borde: #e5e7eb;
}
body {
  background: var(--gris-fondo);
  font-family: 'Inter', sans-serif;
  color: #1f2937;
}
.card {
  background: white;
  border-radius: 0.6rem;
  padding: 1.2rem 1.4rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border-left: 4px solid var(--verde);
}
h2 { color: var(--verde); font-weight: 600; margin-bottom: 0.8rem; }
canvas { max-height: 220px !important; }
.table-container {
  overflow-x: auto;
  background: white;
  border-radius: 0.6rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  padding: 1rem;
}
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th, td { padding: 0.5rem; border-bottom: 1px solid var(--gris-borde); text-align: center; }
th { background: #f1f5f4; color: #374151; font-weight: 600; }
.section { margin-top: 1.8rem; }
</style>
</head>

<body class="p-8">
  <div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold text-[var(--verde)]">Informe Clínico Comparativo</h1>
      <a href="index.html" class="text-[var(--verde)] text-sm hover:underline">Volver al inicio</a>
    </div>

    <!-- CONFIGURACIÓN -->
    <div class="card">
      <h2>Configuración</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Cohortes</label>
          <select id="cohortes" multiple class="border rounded-md p-2 w-full text-sm">
            <option>Diabetes tipo 2</option>
            <option>EPOC</option>
            <option>Insuficiencia cardíaca</option>
            <option>Hipertensión arterial</option>
            <option>Enfermedad renal crónica</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Ctrl + clic para seleccionar varias cohortes</p>
        </div>
        <div>
          <label class="text-sm font-medium">Género</label>
          <select id="genero" class="border rounded-md p-2 w-full text-sm">
            <option value="">Todos</option>
            <option value="F">Femenino</option>
            <option value="M">Masculino</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Edad mínima</label>
          <input id="edadMin" type="number" class="border rounded-md p-2 w-full text-sm" />
        </div>
        <div>
          <label class="text-sm font-medium">Edad máxima</label>
          <input id="edadMax" type="number" class="border rounded-md p-2 w-full text-sm" />
        </div>
        <div class="md:col-span-5 text-right mt-2">
          <button onclick="generarInforme()" class="bg-[var(--verde)] text-white px-5 py-2 rounded-md text-sm hover:bg-[var(--verde-claro)]">Generar Informe</button>
        </div>
      </div>
    </div>

    <!-- BLOQUE DE INFORME -->
    <div id="informe" class="mt-8 space-y-6 hidden">
      
      <!-- Filtros redactados -->
      <div class="card">
        <h2>Resumen de Filtros Aplicados</h2>
        <p id="textoFiltros" class="text-sm text-gray-700"></p>
      </div>

      <!-- Métricas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="resumenCohortes"></div>

      <!-- Gráficos -->
      <div class="section grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <h2>Distribución de Medicaciones</h2>
          <canvas id="graficoMeds"></canvas>
        </div>
        <div class="card">
          <h2>Adherencia Media por Cohorte</h2>
          <canvas id="graficoAdherencia"></canvas>
        </div>
      </div>

      <!-- Tabla comparativa -->
      <div class="section table-container">
        <h2>Comparativa Detallada</h2>
        <table id="tablaComparativa">
          <thead><tr><th>Cohorte</th><th>Pacientes</th><th>Edad media</th><th>IMC medio</th><th>% Mujeres</th><th>% Fumadores</th><th>Adherencia media</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Interpretación -->
      <div class="card section">
        <h2>Interpretación Automática</h2>
        <p id="interpretacion" class="text-sm text-gray-700 leading-relaxed"></p>
      </div>

      <div class="text-right mt-4">
        <button onclick="descargarPDF()" class="bg-gray-700 text-white px-5 py-2 rounded-md text-sm hover:bg-gray-800">Descargar PDF</button>
      </div>
    </div>
  </div>

<script>
const supabase = window.supabase.createClient(
  "https://tmolxeszsgkffurhrcxy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw"
);

let chartMeds, chartAdh;

async function generarInforme() {
  const cohSel = Array.from(document.getElementById("cohortes").selectedOptions).map(o => o.value);
  const genero = document.getElementById("genero").value;
  const edadMin = +document.getElementById("edadMin").value || null;
  const edadMax = +document.getElementById("edadMax").value || null;

  if (!cohSel.length) return alert("Selecciona al menos una cohorte.");

  // Texto redactado de filtros
  let texto = `El informe compara las cohortes ${cohSel.join(", ")}. `;
  if (genero) texto += `Solo se incluyen pacientes de género ${genero === "F" ? "femenino" : "masculino"}. `;
  if (edadMin || edadMax) texto += `El rango de edad analizado es de ${edadMin || "cualquier"} a ${edadMax || "cualquier"} años.`;
  document.getElementById("textoFiltros").textContent = texto;

  // Cargar datos
  const { data: pacientes } = await supabase.from("pacientes").select("*");
  const { data: meds } = await supabase.from("medicaciones").select("principio_activo, adherencia, patient_id");

  // Filtrado
  const filtrados = pacientes.filter(p =>
    cohSel.includes(p.enfermedad_principal) &&
    (!genero || p.sexo === genero) &&
    (!edadMin || p.edad >= edadMin) &&
    (!edadMax || p.edad <= edadMax)
  );

  // Métricas y agregados
  const cohortes = {};
  cohSel.forEach(c => {
    const subset = filtrados.filter(p => p.enfermedad_principal === c);
    if (!subset.length) return;
    const mujeres = subset.filter(p => p.sexo === "F").length;
    const fumadores = subset.filter(p => p.fumador === "Sí").length;
    const ids = subset.map(p => p.patient_id);
    const medsSubset = meds.filter(m => ids.includes(m.patient_id));
    const adherenciaMedia = medsSubset.length ? medsSubset.reduce((a,b)=>a+(+b.adherencia||0),0)/medsSubset.length : 0;
    cohortes[c] = {
      n: subset.length,
      edad: subset.reduce((a,b)=>a+b.edad,0)/subset.length,
      imc: subset.reduce((a,b)=>a+(+b.IMC||0),0)/subset.length,
      mujeres: (mujeres/subset.length)*100,
      fumadores: (fumadores/subset.length)*100,
      adherencia: adherenciaMedia
    };
  });

  // Render
  document.getElementById("informe").classList.remove("hidden");
  renderResumen(cohortes);
  renderTabla(cohortes);
  renderGraficos(cohortes, meds, filtrados);
  renderInterpretacion(cohortes);
}

function renderResumen(cohortes){
  const div = document.getElementById("resumenCohortes");
  div.innerHTML = Object.entries(cohortes).map(([c,v])=>`
    <div class='card'>
      <h3 class='font-semibold text-[var(--verde)] text-sm mb-1'>${c}</h3>
      <p class='text-sm text-gray-600'>Pacientes: <b>${v.n}</b><br>
      Edad media: ${v.edad.toFixed(1)} | IMC: ${v.imc.toFixed(1)}</p>
    </div>`).join("");
}

function renderTabla(cohortes){
  const tbody=document.querySelector("#tablaComparativa tbody");
  tbody.innerHTML=Object.entries(cohortes).map(([c,v])=>`
    <tr><td>${c}</td><td>${v.n}</td><td>${v.edad.toFixed(1)}</td><td>${v.imc.toFixed(1)}</td>
    <td>${v.mujeres.toFixed(1)}%</td><td>${v.fumadores.toFixed(1)}%</td><td>${v.adherencia.toFixed(1)}%</td></tr>`).join("");
}

function renderGraficos(cohortes, meds, filtrados){
  const ctxMeds=document.getElementById("graficoMeds");
  const ctxAdh=document.getElementById("graficoAdherencia");

  // Medicaciones top
  const medsAll=meds.filter(m=>filtrados.some(p=>p.patient_id===m.patient_id));
  const counts={};
  medsAll.forEach(m=>counts[m.principio_activo]=(counts[m.principio_activo]||0)+1);
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const labels=top.map(t=>t[0]), valores=top.map(t=>t[1]);

  if(chartMeds)chartMeds.destroy();
  chartMeds=new Chart(ctxMeds,{
    type:'bar',
    data:{labels,datasets:[{data:valores,backgroundColor:'#3d7658'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  // Adherencia
  if(chartAdh)chartAdh.destroy();
  chartAdh=new Chart(ctxAdh,{
    type:'bar',
    data:{
      labels:Object.keys(cohortes),
      datasets:[{label:'Adherencia (%)',data:Object.values(cohortes).map(v=>v.adherencia.toFixed(1)),backgroundColor:'#4ba67d'}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}
  });
}

function renderInterpretacion(cohortes){
  const keys=Object.keys(cohortes);
  if(keys.length<1)return;
  const maxAdh=keys.reduce((a,b)=>cohortes[a].adherencia>cohortes[b].adherencia?a:b);
  const maxIMC=keys.reduce((a,b)=>cohortes[a].imc>cohortes[b].imc?a:b);
  document.getElementById("interpretacion").textContent=
    `La cohorte con mayor adherencia al tratamiento es ${maxAdh} (${cohortes[maxAdh].adherencia.toFixed(1)}%). `+
    `El IMC medio más alto se observa en ${maxIMC} (${cohortes[maxIMC].imc.toFixed(1)}). `+
    `Estos resultados sugieren diferencias potenciales en los hábitos y seguimiento terapéutico entre cohortes.`;
}

async function descargarPDF(){
  const doc=new jspdf.jsPDF('p','pt','a4');
  const elem=document.getElementById('informe');
  const canvas=await html2canvas(elem,{scale:2});
  const img=canvas.toDataURL('image/png');
  const imgWidth=550;
  const pageHeight=800;
  const imgHeight=canvas.height*imgWidth/canvas.width;
  let heightLeft=imgHeight;
  let position=20;
  doc.addImage(img,'PNG',30,position,imgWidth,imgHeight);
  doc.save('informe_clinico.pdf');
}
</script>
</body>
</html>
