<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Informe Clínico Comparativo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --verde: #2f6d50;
  --verde-claro: #4fa87b;
  --gris-fondo: #f9faf9;
}
body {
  font-family: 'Inter', sans-serif;
  background-color: var(--gris-fondo);
  color: #1a1a1a;
  display: flex;
  justify-content: center;
}
main {
  max-width: 900px;
  width: 100%;
  padding: 1.5rem;
}
header { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.4rem; margin-bottom: 1rem; }
.section {
  background: white;
  border-radius: 0.6rem;
  padding: 1.2rem 1.4rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  margin-bottom: 1rem;
}
.card {
  background: #f3f7f4;
  border-left: 3px solid var(--verde);
  border-radius: 0.4rem;
  padding: 0.6rem 0.8rem;
  font-size: 0.85rem;
}
.card h3 {
  color: var(--verde);
  font-weight: 600;
  margin-bottom: 0.1rem;
  font-size: 0.95rem;
}
canvas {
  max-height: 150px !important;
  margin-top: 10px;
}
.table-custom {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
  margin-top: 0.8rem;
}
.table-custom th, .table-custom td {
  border: 1px solid #e5e7eb;
  padding: 0.4rem 0.6rem;
  text-align: center;
}
.table-custom th {
  background: #f3f6f4;
  color: #1a1a1a;
  font-weight: 600;
}
.table-custom tbody tr:nth-child(even) {
  background-color: #fafafa;
}
.btn-main {
  background: linear-gradient(90deg, var(--verde) 0%, var(--verde-claro) 100%);
  color: white;
  border: none;
  padding: 0.45rem 1rem;
  border-radius: 0.35rem;
  font-weight: 500;
  font-size: 0.85rem;
  transition: 0.25s;
}
.btn-main:hover { filter: brightness(1.1); }
</style>
</head>

<body>
<main>
<header class="flex justify-between items-center">
  <h1 class="text-xl font-semibold text-[var(--verde)]">Informe Clínico Comparativo</h1>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">Volver al inicio</a>
</header>

<section class="section">
  <h2 class="font-semibold mb-3 text-[var(--verde)]">Configuración</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="text-xs font-semibold">Cohortes</label>
      <select id="selCohortes" multiple class="w-full border border-gray-300 rounded-md p-1.5 text-sm h-24"></select>
      <p class="text-xs text-gray-500 mt-1">Ctrl + clic para varias cohortes</p>
    </div>
    <div>
      <label class="text-xs font-semibold">Filtros</label>
      <div class="grid grid-cols-2 gap-2 mt-1">
        <input id="fGenero" placeholder="Género (M/F)" class="border rounded-md p-1 text-sm">
        <input id="fEdadMin" placeholder="Edad mín." type="number" class="border rounded-md p-1 text-sm">
        <input id="fEdadMax" placeholder="Edad máx." type="number" class="border rounded-md p-1 text-sm">
        <input id="fIMC" placeholder="IMC mín." type="number" class="border rounded-md p-1 text-sm">
      </div>
    </div>
    <div class="flex items-end">
      <button onclick="generarInforme()" class="btn-main w-full">Generar Informe</button>
    </div>
  </div>
</section>

<section id="informe" class="section hidden">
  <div id="resumen" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>
  <div id="graficos" class="grid grid-cols-2 gap-4 mb-4"></div>

  <h3 class="text-[var(--verde)] font-semibold mt-4 mb-2">Comparativa detallada</h3>
  <div id="tablaContainer"></div>

  <div class="text-right mt-3">
    <button onclick="descargarPDF()" class="btn-main">Descargar PDF</button>
  </div>
</section>

<script>
const supabase = window.supabase.createClient(
  "https://tmolxeszsgkffurhrcxy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw"
);

let charts=[];

async function cargarCohortes(){
  const { data } = await supabase.from("pacientes").select("enfermedad_principal");
  const unicas=[...new Set(data.map(d=>d.enfermedad_principal).filter(Boolean))];
  document.getElementById("selCohortes").innerHTML=unicas.map(u=>`<option>${u}</option>`).join("");
}
cargarCohortes();

function promedio(arr){return arr.length?(arr.reduce((a,b)=>a+(+b||0),0)/arr.length).toFixed(1):0;}
function filtrar(p,genero,edadMin,edadMax,imcMin){
  return p.filter(x=>{
    if(genero && x.sexo?.toUpperCase()!==genero.toUpperCase()) return false;
    if(edadMin && x.edad<edadMin) return false;
    if(edadMax && x.edad>edadMax) return false;
    if(imcMin && (x.IMC||0)<imcMin) return false;
    return true;
  });
}

async function generarInforme(){
  const cohortes=Array.from(document.getElementById("selCohortes").selectedOptions).map(o=>o.value);
  if(!cohortes.length) return alert("Selecciona al menos una cohorte.");

  const genero=document.getElementById("fGenero").value.trim();
  const edadMin=+document.getElementById("fEdadMin").value||null;
  const edadMax=+document.getElementById("fEdadMax").value||null;
  const imcMin=+document.getElementById("fIMC").value||null;

  const { data: todos } = await supabase.from("pacientes").select("*");
  const mediaGlobal={
    edad:promedio(todos.map(x=>x.edad)),
    imc:promedio(todos.map(x=>x.IMC)),
    fem:(todos.filter(x=>x.sexo?.toLowerCase().startsWith("f")).length/todos.length*100).toFixed(1),
    fum:(todos.filter(x=>x.fumador==="Sí"||x.fumador==="si").length/todos.length*100).toFixed(1),
    riesgo:promedio(todos.map(x=>parseFloat(x.gravedad_score||0)))
  };

  document.getElementById("informe").classList.remove("hidden");
  document.getElementById("resumen").innerHTML="";
  document.getElementById("graficos").innerHTML="";
  document.getElementById("tablaContainer").innerHTML="";
  charts.forEach(c=>c.destroy());

  const resumen=[];
  for(const enf of cohortes){
    const { data: p }=await supabase.from("pacientes").select("*").ilike("enfermedad_principal",`%${enf}%`);
    const pacientes=filtrar(p,genero,edadMin,edadMax,imcMin);
    const edad=promedio(pacientes.map(x=>x.edad));
    const imc=promedio(pacientes.map(x=>x.IMC));
    const fem=pacientes.filter(x=>x.sexo?.toLowerCase().startsWith("f")).length;
    const fum=pacientes.filter(x=>x.fumador==="Sí"||x.fumador==="si").length;
    const riesgo=promedio(pacientes.map(x=>parseFloat(x.gravedad_score||0)));
    resumen.push({cohorte:enf,n:pacientes.length,edad,imc,fem,porFem:(fem/pacientes.length*100).toFixed(1),fum:(fum/pacientes.length*100).toFixed(1),riesgo});
  }

  resumen.forEach(r=>{
    document.getElementById("resumen").innerHTML+=`
      <div class="card"><h3>${r.cohorte}</h3>
      <p>Pacientes: <b>${r.n}</b></p>
      <p>Edad media: ${r.edad} | IMC: ${r.imc}</p></div>`;
  });

  const labels=resumen.map(r=>r.cohorte);
  const metricas=[
    {titulo:"Edad media",data:resumen.map(r=>r.edad),media:mediaGlobal.edad},
    {titulo:"IMC medio",data:resumen.map(r=>r.imc),media:mediaGlobal.imc},
    {titulo:"% Mujeres",data:resumen.map(r=>r.porFem),media:mediaGlobal.fem},
    {titulo:"% Fumadores",data:resumen.map(r=>r.fum),media:mediaGlobal.fum},
    {titulo:"Riesgo clínico medio",data:resumen.map(r=>r.riesgo),media:mediaGlobal.riesgo}
  ];

  metricas.forEach(m=>{
    const c=document.createElement("canvas");
    document.getElementById("graficos").appendChild(c);
    const g=new Chart(c,{
      type:"bar",
      data:{labels,datasets:[
        {label:m.titulo,data:m.data,backgroundColor:"#4ba67d"},
        {label:"Media global",data:new Array(labels.length).fill(m.media),type:"line",borderColor:"#888",borderWidth:1,pointRadius:0,fill:false}
      ]},
      options:{plugins:{legend:{display:false},title:{display:true,text:m.titulo,color:"#2f6d50"}},scales:{y:{beginAtZero:true},x:{ticks:{font:{size:10}}}}}
    });
    charts.push(g);
  });

  document.getElementById("tablaContainer").innerHTML=`
    <table class="table-custom">
      <thead><tr><th>Cohorte</th><th>Pacientes</th><th>Edad</th><th>IMC</th><th>% Mujeres</th><th>% Fumadores</th><th>Riesgo</th></tr></thead>
      <tbody>${resumen.map(r=>`
        <tr><td>${r.cohorte}</td><td>${r.n}</td><td>${r.edad}</td><td>${r.imc}</td>
        <td>${r.porFem}%</td><td>${r.fum}%</td><td>${r.riesgo}</td></tr>`).join("")}</tbody>
    </table>`;
}

async function descargarPDF(){
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const elem=document.getElementById("informe");
  await html2canvas(elem,{scale:2}).then(canvas=>{
    const img=canvas.toDataURL("image/png");
    const w=pdf.internal.pageSize.getWidth();
    const h=canvas.height*w/canvas.width;
    pdf.addImage(img,"PNG",0,0,w,h);
    pdf.save("Informe_Clinico.pdf");
  });
}
</script>
</main>
</body>
</html>
