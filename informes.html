<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Recomendaciones Clínicas Inteligentes</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    background-color: var(--gris-fondo);
    font-family: 'Inter', sans-serif;
  }
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-bottom: 1px solid #e5e7eb;
  }
  .card {
    background: white;
    border-radius: 0.8rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    padding: 1.5rem;
  }
  .btn {
    background: var(--verde);
    color: white;
    border-radius: 0.4rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: 0.3s;
  }
  .btn:hover { background: var(--verde-claro); }
</style>
</head>

<body class="min-h-screen flex flex-col">
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Recomendaciones Clínicas</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al panel</a>
</header>

<main class="flex-1 p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
  <!-- Panel izquierdo: filtros -->
  <section class="card space-y-4">
    <h2 class="text-lg font-semibold text-[var(--verde)]">Configuración del análisis</h2>
    <p class="text-gray-600 text-sm">Selecciona la cohorte o define un grupo específico para generar recomendaciones automáticas.</p>

    <label class="block text-sm font-medium text-gray-700">Cohorte</label>
    <select id="cohorte" class="border rounded-md w-full p-2">
      <option>Enfermedad renal crónica</option>
      <option>Diabetes tipo 2</option>
      <option>EPOC</option>
      <option>Hipertensión arterial</option>
      <option>Insuficiencia cardíaca</option>
    </select>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700">Edad mínima</label>
        <input id="edadMin" type="number" class="border rounded-md w-full p-2" placeholder="Ej: 50">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Edad máxima</label>
        <input id="edadMax" type="number" class="border rounded-md w-full p-2" placeholder="Ej: 80">
      </div>
    </div>

    <label class="block text-sm font-medium text-gray-700">Condición adicional</label>
    <input id="condicion" type="text" class="border rounded-md w-full p-2" placeholder="Ej: HbA1c > 7">

    <button onclick="generarAcciones()" class="btn w-full mt-2">Generar recomendaciones</button>

    <div id="loading" class="hidden text-sm text-gray-500 mt-3">
      <span class="animate-spin inline-block border-2 border-[var(--verde)] border-t-transparent rounded-full w-4 h-4 mr-2"></span>
      Analizando datos clínicos...
    </div>
  </section>

  <!-- Panel derecho: resultados -->
  <section class="card">
    <h2 class="text-lg font-semibold text-[var(--verde)] mb-3">Resultados</h2>
    <div id="resultadosBox" class="text-gray-600 text-sm">
      <p>Completa los filtros y pulsa <b>"Generar recomendaciones"</b> para obtener sugerencias clínicas personalizadas.</p>
    </div>
  </section>
</main>

<script>
lucide.createIcons();

async function generarAcciones() {
  const cohorte = document.getElementById("cohorte").value;
  const edadMin = document.getElementById("edadMin").value || null;
  const edadMax = document.getElementById("edadMax").value || null;
  const condicion = document.getElementById("condicion").value;
  const loading = document.getElementById("loading");
  const resultados = document.getElementById("resultadosBox");

  resultados.innerHTML = "";
  loading.classList.remove("hidden");

  // Preparar payload para n8n
  const payload = {
    cohorte,
    filtros: { edadMin, edadMax, condicion },
    sql: `
      SELECT *
      FROM pacientes
      WHERE enfermedad_principal ILIKE '%${cohorte}%'
      ${edadMin ? `AND edad >= ${edadMin}` : ""}
      ${edadMax ? `AND edad <= ${edadMax}` : ""}
      ${condicion ? `AND ${condicion}` : ""}
      LIMIT 200;
    `
  };

  try {
    const res = await fetch("https://nano33.app.n8n.cloud/webhook-test/acciones-clinicas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    loading.classList.add("hidden");

    resultados.innerHTML = `
      <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
        <h3 class="font-semibold mb-2 text-gray-800">Sugerencias clínicas para ${cohorte}</h3>
        <ul class="list-disc list-inside text-sm text-gray-700 mb-3">
          ${(data.acciones || ["Sin recomendaciones específicas"]).map(a => `<li>${a}</li>`).join("")}
        </ul>
        <p class="text-sm text-gray-600 border-t pt-2">
          <b>Justificación:</b> ${data.justificacion || "Análisis basado en las últimas métricas clínicas disponibles."}
        </p>
      </div>`;
  } catch (e) {
    loading.classList.add("hidden");
    resultados.innerHTML = `<p class="text-red-500 text-sm">Error al generar recomendaciones.</p>`;
  }
}
</script>
</body>
</html>
