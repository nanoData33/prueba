<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ ‚Äî Informe Comparativo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --verde: #3d7658;
  --verde-claro: #4ba67d;
  --gris-fondo: #f8f9f8;
}
body { font-family: 'Inter', sans-serif; background-color: var(--gris-fondo); color: #1c1c1c; }
.section { background: white; border-radius: 0.8rem; padding: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.card { background:#f1f7f4; padding:1rem; border-radius:0.6rem; text-align:center; }
.card h3 { color:var(--verde); font-weight:600; }
.table-custom th { background: #eef3ef; text-align:center; }
.table-custom td, .table-custom th { padding: 0.4rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
.btn-main { background: linear-gradient(90deg, var(--verde) 0%, var(--verde-claro) 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.4rem; font-weight: 500; font-size: 0.9rem; transition: 0.25s; }
.btn-main:hover { filter: brightness(1.1); transform: translateY(-1px); }
canvas { max-height: 180px !important; }
</style>
</head>

<body class="p-8">
<header class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-semibold flex items-center gap-2 text-[var(--verde)]">
    <i data-lucide="bar-chart-2"></i> Generador Comparativo de Informes
  </h1>
  <a href="index.html" class="text-[var(--verde)] hover:underline text-sm">‚Üê Volver al inicio</a>
</header>

<!-- CONFIGURACI√ìN -->
<section class="section mb-6">
  <h2 class="text-lg font-semibold mb-3">Configuraci√≥n del an√°lisis</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="text-sm font-semibold">Selecciona cohortes</label>
      <select id="selCohortes" multiple class="w-full border border-gray-300 rounded-md p-2 mt-1 text-sm h-28"></select>
      <p class="text-xs text-gray-500 mt-1">Ctrl + clic para varias cohortes</p>
    </div>
    <div>
      <label class="text-sm font-semibold">Filtros opcionales</label>
      <div class="grid grid-cols-2 gap-2 text-sm mt-1">
        <input id="fGenero" placeholder="G√©nero (M/F)" class="border rounded-md p-1.5" />
        <input id="fEdadMin" placeholder="Edad m√≠n." type="number" class="border rounded-md p-1.5" />
        <input id="fEdadMax" placeholder="Edad m√°x." type="number" class="border rounded-md p-1.5" />
        <input id="fIMC" placeholder="IMC m√≠n." type="number" class="border rounded-md p-1.5" />
      </div>
    </div>
    <div class="flex items-end">
      <button onclick="generarInforme()" class="btn-main w-full">Generar Informe</button>
    </div>
  </div>
</section>

<!-- RESULTADOS -->
<section id="informe" class="section hidden">
  <div id="resumen" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>

  <div id="graficos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

  <div id="tablaContainer" class="mt-6"></div>

  <div class="text-right mt-6">
    <button onclick="descargarPDF()" class="btn-main">üìÑ Descargar PDF</button>
  </div>
</section>

<script>
const supabase = window.supabase.createClient(
  "https://tmolxeszsgkffurhrcxy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw"
);

let charts = [];

async function cargarCohortes() {
  const { data } = await supabase.from("pacientes").select("enfermedad_principal");
  const unicas = [...new Set(data.map(d => d.enfermedad_principal).filter(Boolean))];
  document.getElementById("selCohortes").innerHTML = unicas.map(u => `<option>${u}</option>`).join("");
}
cargarCohortes();

function promedio(arr){return arr.length ? (arr.reduce((a,b)=>a+(+b||0),0)/arr.length).toFixed(1) : null;}

function filtrarPacientes(p, genero, edadMin, edadMax, imcMin){
  return p.filter(x=>{
    if(genero && x.sexo?.toUpperCase()!==genero.toUpperCase()) return false;
    if(edadMin && x.edad<edadMin) return false;
    if(edadMax && x.edad>edadMax) return false;
    if(imcMin && (x.IMC||0)<imcMin) return false;
    return true;
  });
}

async function generarInforme(){
  const cohortesSel = Array.from(document.getElementById("selCohortes").selectedOptions).map(o=>o.value);
  if(cohortesSel.length===0) return alert("Selecciona al menos una cohorte.");

  const genero = document.getElementById("fGenero").value.trim();
  const edadMin = +document.getElementById("fEdadMin").value || null;
  const edadMax = +document.getElementById("fEdadMax").value || null;
  const imcMin = +document.getElementById("fIMC").value || null;

  document.getElementById("informe").classList.remove("hidden");
  const resumenDiv = document.getElementById("resumen");
  const graficosDiv = document.getElementById("graficos");
  const tablaDiv = document.getElementById("tablaContainer");

  resumenDiv.innerHTML = "";
  graficosDiv.innerHTML = "";
  tablaDiv.innerHTML = "";
  charts.forEach(c=>c.destroy());

  const resumen = [];

  for(const enf of cohortesSel){
    const { data: p } = await supabase.from("pacientes").select("*").ilike("enfermedad_principal", `%${enf}%`);
    const pacientes = filtrarPacientes(p, genero, edadMin, edadMax, imcMin);
    const edad = promedio(pacientes.map(x=>x.edad));
    const imc = promedio(pacientes.map(x=>x.IMC));
    const fem = pacientes.filter(x=>x.sexo?.toLowerCase().startsWith("f")).length;
    const masc = pacientes.length - fem;
    const fum = pacientes.filter(x=>x.fumador==="S√≠"||x.fumador==="si").length;
    const seg = pacientes.filter(x=>x.seguimiento_activo).length;
    const riesgo = promedio(pacientes.map(x=>parseFloat(x.gravedad_score||0)));

    resumen.push({ cohorte: enf, n: pacientes.length, edad, imc, fem, masc, fum, seg, riesgo });
  }

  // Tarjetas resumen
  resumen.forEach(r=>{
    resumenDiv.innerHTML += `
      <div class="card">
        <h3>${r.cohorte}</h3>
        <p class="text-sm mt-1 text-gray-700">Pacientes: <b>${r.n}</b></p>
        <p class="text-xs text-gray-500">Edad media: ${r.edad} | IMC: ${r.imc}</p>
      </div>`;
  });

  // Gr√°ficos compactos
  const labels = resumen.map(r=>r.cohorte);
  const metricas = [
    {titulo:"Edad media", data:resumen.map(r=>r.edad), color:"#4ba67d"},
    {titulo:"IMC medio", data:resumen.map(r=>r.imc), color:"#f7c15a"},
    {titulo:"% Mujeres", data:resumen.map(r=>((r.fem/r.n)*100).toFixed(1)), color:"#e58b7c"},
    {titulo:"% Fumadores", data:resumen.map(r=>((r.fum/r.n)*100).toFixed(1)), color:"#3d7658"},
    {titulo:"Seguimiento activo (%)", data:resumen.map(r=>((r.seg/r.n)*100).toFixed(1)), color:"#b08ef9"},
    {titulo:"Riesgo medio", data:resumen.map(r=>r.riesgo||0), color:"#888"}
  ];

  for(const m of metricas){
    const c = document.createElement("canvas");
    graficosDiv.appendChild(c);
    const g = new Chart(c,{
      type:"bar",
      data:{labels,datasets:[{label:m.titulo,data:m.data,backgroundColor:m.color}]},
      options:{plugins:{legend:{display:false},title:{display:true,text:m.titulo}},responsive:true,scales:{y:{beginAtZero:true}}}
    });
    charts.push(g);
  }

  // Tabla resumen
  tablaDiv.innerHTML = `
    <h3 class="text-[var(--verde)] font-semibold mb-2">Comparativa detallada</h3>
    <table class="table-custom w-full text-xs">
      <thead><tr><th>Cohorte</th><th>Pacientes</th><th>Edad</th><th>IMC</th><th>% Mujeres</th><th>% Fumadores</th><th>Riesgo</th></tr></thead>
      <tbody>${resumen.map(r=>`
        <tr><td>${r.cohorte}</td><td>${r.n}</td><td>${r.edad}</td><td>${r.imc}</td>
        <td>${((r.fem/r.n)*100).toFixed(1)}%</td><td>${((r.fum/r.n)*100).toFixed(1)}%</td><td>${r.riesgo||"-"}</td></tr>`).join("")}</tbody>
    </table>
    <p class="text-xs italic text-gray-600 mt-3">
      El an√°lisis refleja las diferencias de perfil cl√≠nico entre cohortes seleccionadas.
      Se recomienda profundizar en las variables con desviaciones significativas para identificar patrones de riesgo o adherencia.</p>`;
}

async function descargarPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const elem = document.getElementById("informe");
  await html2canvas(elem,{scale:2}).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    const width = pdf.internal.pageSize.getWidth();
    const height = canvas.height * width / canvas.width;
    pdf.addImage(img,"PNG",0,0,width,height);
    pdf.save("Informe_Comparativo.pdf");
  });
}
</script>
</body>
</html>
