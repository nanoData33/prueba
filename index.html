<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CohortIQ — Clinical Research Assistant</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { background-color:#f6f7f5; font-family:"Inter",sans-serif; color:#1f1f1f; }
  header { background:white; border-bottom:1px solid #e5e7eb; box-shadow:0 1px 6px rgba(0,0,0,0.05); }
  .section-title { font-weight:600; color:#374151; font-size:1rem; margin-bottom:0.8rem; text-transform:uppercase; }
  .card { background:white; border-radius:0.8rem; padding:1.4rem; border-left:4px solid #4a8c3f; box-shadow:0 2px 6px rgba(0,0,0,0.05); transition:all .2s ease; cursor:pointer; }
  .card:hover { transform:translateY(-3px); box-shadow:0 5px 12px rgba(0,0,0,0.08); }
  .card h3 { font-weight:600; color:#1f1f1f; }
  .card p { color:#6b7280; font-size:0.9rem; margin-top:3px; }
  .cohorte { background:white; border-radius:0.6rem; padding:0.9rem 1rem; border-left:4px solid #4a8c3f; display:flex; justify-content:space-between; align-items:center; }
  .btn { background:#4a8c3f; color:white; border:none; padding:0.6rem 1rem; border-radius:0.4rem; font-weight:500; transition:all .2s ease; }
  .btn:hover { background:#3b7033; }
</style>
</head>

<body>
  <!-- HEADER -->
  <header class="w-full flex justify-between items-center px-10 py-4">
    <h1 class="flex items-center gap-2 text-xl font-semibold text-lime-800">
      <i data-lucide="activity"></i> CohortIQ
      <span class="text-gray-500 text-sm font-normal">Clinical Research Assistant</span>
    </h1>
    <a href="chat.html" class="btn flex items-center gap-2"><i data-lucide="bot"></i> Asistente Conversacional</a>
  </header>

  <!-- MAIN CONTENT -->
  <main class="px-10 py-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
    
    <!-- IZQUIERDA -->
    <section>
      <h2 class="section-title">Resumen de Cohortes Activas</h2>
      <div id="cohortes" class="flex flex-col gap-3">
        <p class="text-gray-400 italic">Cargando cohortes...</p>
      </div>
    </section>

    <!-- DERECHA -->
    <section>
      <h2 class="section-title">Herramientas de Investigación</h2>
      <div class="flex flex-col gap-5">
        <div class="card" onclick="location.href='clasificar.html'">
          <div class="flex items-center gap-2 mb-1">
            <i data-lucide='user-plus' class='text-lime-700'></i>
            <h3>Clasificar nuevo paciente</h3>
          </div>
          <p>Sube una analítica o introduce valores clínicos para ubicar al paciente en una cohorte y obtener una interpretación automática.</p>
        </div>

        <div class="card" onclick="location.href='explorar.html'">
          <div class="flex items-center gap-2 mb-1">
            <i data-lucide='database' class='text-lime-700'></i>
            <h3>Explorar base de datos</h3>
          </div>
          <p>Consulta todos los pacientes mediante filtros y búsqueda inteligente sin usar SQL.</p>
        </div>

        <div class="card" onclick="location.href='comparar.html'">
          <div class="flex items-center gap-2 mb-1">
            <i data-lucide='bar-chart-2' class='text-lime-700'></i>
            <h3>Comparar cohortes</h3>
          </div>
          <p>Analiza diferencias entre cohortes por edad, sexo o enfermedad principal, con gráficos automáticos.</p>
        </div>

        <div class="card" onclick="location.href='informes.html'">
          <div class="flex items-center gap-2 mb-1">
            <i data-lucide='file-bar-chart' class='text-lime-700'></i>
            <h3>Informes y asistente</h3>
          </div>
          <p>Genera informes automáticos sobre cohortes o conversa con el asistente n8n para explorar datos y obtener análisis.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="text-center text-sm text-gray-400 py-3 border-t border-gray-200">
    © 2025 CohortIQ · Plataforma de Análisis de Cohortes Clínicas
  </footer>

  <script>
    lucide.createIcons();

    // === SUPABASE CONNECTION ===
    const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function cargarCohortes() {
      const c = document.getElementById("cohortes");
      const { data, error } = await supabase.from("pacientes").select("enfermedad_principal");
      if (error) { c.innerHTML = "<p class='text-red-600'>Error al conectar con Supabase.</p>"; console.error(error); return; }

      const conteo = {};
      data.forEach(p => {
        const enf = p.enfermedad_principal || "Sin especificar";
        conteo[enf] = (conteo[enf] || 0) + 1;
      });

      c.innerHTML = Object.entries(conteo)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5)
        .map(([e,t])=>`
          <div class='cohorte'>
            <div>
              <h4 class='font-semibold text-gray-800'>${e}</h4>
              <p class='text-gray-500 text-sm'>${t} pacientes registrados</p>
            </div>
            <button onclick="location.href='cohorte.html?nombre=${encodeURIComponent(e)}'" class='btn text-sm'>Ver cohorte</button>
          </div>
        `).join("");
    }

    cargarCohortes();
  </script>
</body>
</html>
