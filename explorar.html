<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Explorador Clínico Avanzado</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-bottom: 1px solid #e5e7eb;
  }
  .tab {
    cursor: pointer;
    padding: 0.8rem 1.4rem;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: 0.25s;
  }
  .tab.active {
    border-color: var(--verde);
    color: var(--verde);
    font-weight: 600;
  }
  .panel {
    background: white;
    border-radius: 0.9rem;
    padding: 1.2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: 0.25s;
  }
  .panel:hover { transform: translateY(-1px); }
  .chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Explorador Clínico</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
</header>

<!-- Pestañas -->
<div class="flex border-b bg-white sticky top-0 z-10">
  <div class="tab active" onclick="cambiarVista('pacientes')">Pacientes</div>
  <div class="tab" onclick="cambiarVista('laboratorios')">Laboratorios</div>
  <div class="tab" onclick="cambiarVista('medicaciones')">Medicaciones</div>
</div>

<main id="contenedor" class="p-6"></main>

<script>
lucide.createIcons();

const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let vistaActual = "pacientes";

// Cambiar pestañas
function cambiarVista(vista) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[onclick="cambiarVista('${vista}')"]`).classList.add("active");
  vistaActual = vista;
  if (vista === "pacientes") cargarPacientes();
  if (vista === "laboratorios") cargarLaboratorios();
  if (vista === "medicaciones") cargarMedicaciones();
}

/* ==========================
   1. PACIENTES
========================== */
async function cargarPacientes() {
  const { data } = await supabase.from("pacientes").select("*").limit(100);
  const cont = document.getElementById("contenedor");
  cont.innerHTML = `
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <section class="panel">
      <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="users"></i> Pacientes</h2>
      <input id="buscador" placeholder="Buscar..." oninput="filtrarPacientes()" class="w-full p-2 mb-3 border rounded-md">
      <div id="listaPacientes"></div>
    </section>
    <section class="xl:col-span-2 panel overflow-y-auto max-h-[80vh]" id="detallePaciente">
      <p class="text-center text-gray-400 italic">Selecciona un paciente para ver detalles</p>
    </section>
  </div>`;
  lucide.createIcons();
  window.pacientes = data;
  renderPacientes(data);
}

function renderPacientes(lista) {
  const cont = document.getElementById("listaPacientes");
  cont.innerHTML = lista.map(p => `
    <div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer" onclick="verPaciente('${p.patient_id}')">
      <p class="font-medium">${p.nombre} ${p.apellido || ""}</p>
      <p class="text-xs text-gray-500">${p.edad} años • ${p.enfermedad_principal || "Sin diagnóstico"}</p>
      <span class="chip ${p.IMC>30?'riesgo-alto':p.IMC>25?'riesgo-medio':'riesgo-bajo'}">IMC ${p.IMC}</span>
    </div>`).join("");
}
function filtrarPacientes() {
  const q = document.getElementById("buscador").value.toLowerCase();
  renderPacientes(pacientes.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

async function verPaciente(id) {
  const p = pacientes.find(x => x.patient_id === id);
  const [labs, meds] = await Promise.all([
    supabase.from("laboratorios").select("*").eq("patient_id", id),
    supabase.from("medicaciones").select("*").eq("patient_id", id)
  ]);
  const labData = labs.data || [];
  const promedioHb = avg(labData.map(x => x.HbA1c));
  const promedioTFG = avg(labData.map(x => x.TFG));
  const riesgo = promedioHb>7||promedioTFG<60?"riesgo-alto":promedioHb>6?"riesgo-medio":"riesgo-bajo";

  document.getElementById("detallePaciente").innerHTML = `
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold text-[var(--verde)]">${p.nombre} ${p.apellido}</h2>
    <span class="chip ${riesgo}">${riesgo.replace("riesgo-","").toUpperCase()}</span>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
    <div>
      <p><b>Edad:</b> ${p.edad}</p>
      <p><b>Sexo:</b> ${p.sexo}</p>
      <p><b>Actividad física:</b> ${p.actividad_física}</p>
      <p><b>IMC:</b> ${p.IMC}</p>
    </div>
    <div>
      <p><b>Diagnóstico principal:</b> ${p.enfermedad_principal}</p>
      <p><b>Fumador:</b> ${p.fumador}</p>
      <p><b>Nivel socioeconómico:</b> ${p.nivel_socioeconómico}</p>
      <p><b>Educación:</b> ${p.nivel_educativo}</p>
    </div>
  </div>

  <div class="flex gap-4 overflow-x-auto">
    <canvas id="graficoLabs" width="300" height="200"></canvas>
    <canvas id="graficoExtra" width="300" height="200"></canvas>
  </div>`;
  renderGraficoLabs(labData);
  renderGraficoExtra(labData);
}

/* ==========================
   2. LABORATORIOS
========================== */
async function cargarLaboratorios() {
  const { data } = await supabase.from("laboratorios").select("*").limit(200);
  const cont = document.getElementById("contenedor");
  const mediaHb = avg(data.map(x=>x.HbA1c));
  const mediaTFG = avg(data.map(x=>x.TFG));
  cont.innerHTML = `
  <div class="panel mb-6">
    <h2 class="text-lg font-semibold text-[var(--verde)] mb-2">Resumen general de laboratorio</h2>
    <div class="grid grid-cols-5 gap-3 text-center">
      <div class="panel"><p class="text-gray-500 text-sm">HbA1c media</p><p class="text-lg font-semibold">${mediaHb.toFixed(1)}%</p></div>
      <div class="panel"><p class="text-gray-500 text-sm">TFG media</p><p class="text-lg font-semibold">${mediaTFG.toFixed(0)}</p></div>
      <div class="panel"><p class="text-gray-500 text-sm">Pacientes</p><p class="text-lg font-semibold">${new Set(data.map(x=>x.patient_id)).size}</p></div>
      <div class="panel"><p class="text-gray-500 text-sm">Alertas TFG<60</p><p class="text-lg font-semibold text-red-600">${data.filter(x=>x.TFG<60).length}</p></div>
      <div class="panel"><p class="text-gray-500 text-sm">Muestras totales</p><p class="text-lg font-semibold">${data.length}</p></div>
    </div>
  </div>
  <div class="panel">
    <canvas id="graficoLabGlobal" height="200"></canvas>
  </div>`;
  renderGraficoLabGlobal(data);
}

/* ==========================
   3. MEDICACIONES
========================== */
async function cargarMedicaciones() {
  const { data } = await supabase.from("medicaciones").select("*").limit(200);
  const cont = document.getElementById("contenedor");
  cont.innerHTML = `
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <section class="panel overflow-y-auto max-h-[80vh]">
      <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="pill"></i> Medicaciones</h2>
      <div id="listaMeds"></div>
    </section>
    <section class="panel" id="detalleMed"></section>
  </div>`;
  lucide.createIcons();
  const grupos = {};
  data.forEach(m => {
    if (!grupos[m.principio_activo]) grupos[m.principio_activo] = [];
    grupos[m.principio_activo].push(m);
  });
  document.getElementById("listaMeds").innerHTML = Object.keys(grupos).map(k => {
    const promAdh = avg(grupos[k].map(x => x["adherencia_%"]));
    return `<div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer" onclick="verMed('${k}')">
      <p class="font-medium">${k}</p>
      <p class="text-xs text-gray-500">Adherencia media: ${promAdh.toFixed(1)}%</p>
    </div>`;
  }).join("");
  window.medsData = grupos;
}

function verMed(nombre) {
  const arr = medsData[nombre];
  const promDosis = avg(arr.map(x=>x.dosis_diaria_mg));
  const promAdh = avg(arr.map(x=>x["adherencia_%"]));
  document.getElementById("detalleMed").innerHTML = `
    <h2 class="text-lg font-semibold text-[var(--verde)] mb-3">${nombre}</h2>
    <p class="text-sm text-gray-600 mb-2">Pacientes tratados: ${arr.length}</p>
    <div class="grid grid-cols-2 gap-3 mb-3 text-center">
      <div class="panel"><p class="text-gray-500 text-sm">Dosis media</p><p class="text-lg font-semibold">${promDosis.toFixed(1)} mg</p></div>
      <div class="panel"><p class="text-gray-500 text-sm">Adherencia media</p><p class="text-lg font-semibold">${promAdh.toFixed(1)}%</p></div>
    </div>
    <canvas id="graficoMed" height="180"></canvas>`;
  renderGraficoMed(arr);
}

/* ==========================
   Gráficos
========================== */
function avg(arr){return arr.filter(x=>x).reduce((a,b)=>a+b,0)/(arr.filter(x=>x).length||1)}

function renderGraficoLabs(data){
  const ctx = document.getElementById("graficoLabs");
  new Chart(ctx,{type:"line",data:{
    labels:data.map(l=>l.fecha_prueba),
    datasets:[
      {label:"HbA1c",data:data.map(l=>l.HbA1c),borderColor:"#f97316",tension:0.3},
      {label:"TFG",data:data.map(l=>l.TFG),borderColor:"#2563eb",tension:0.3,yAxisID:"y1"}
    ]},
    options:{scales:{y:{title:{display:true,text:"HbA1c"}},y1:{position:"right",title:{display:true,text:"TFG"}}}}
  });
}

function renderGraficoExtra(data){
  const ctx = document.getElementById("graficoExtra");
  new Chart(ctx,{type:"bar",data:{
    labels:data.map(l=>l.fecha_prueba),
    datasets:[
      {label:"Colesterol",data:data.map(l=>l.colesterol_total),backgroundColor:"#4aba84"},
      {label:"Triglicéridos",data:data.map(l=>l.triglicéridos),backgroundColor:"#94a3b8"}
    ]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function renderGraficoLabGlobal(data){
  const ctx = document.getElementById("graficoLabGlobal");
  new Chart(ctx,{type:"scatter",data:{
    datasets:[{label:"HbA1c vs TFG",data:data.map(d=>({x:d.HbA1c,y:d.TFG})),backgroundColor:"#4aba84"}]},
    options:{scales:{x:{title:{display:true,text:"HbA1c"}},y:{title:{display:true,text:"TFG"}}}}
  });
}

function renderGraficoMed(data){
  const ctx = document.getElementById("graficoMed");
  new Chart(ctx,{type:"bar",data:{
    labels:data.map(m=>m.patient_id),
    datasets:[
      {label:"Dosis (mg)",data:data.map(m=>m.dosis_diaria_mg),backgroundColor:"#4aba84"},
      {label:"Adherencia (%)",data:data.map(m=>m["adherencia_%"]),backgroundColor:"#93c5fd"}
    ]},
    options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{position:"bottom"}}}
  });
}

cambiarVista("pacientes");
</script>
</body>
</html>
