<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ ‚Äî Historia Cl√≠nica Avanzada</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }
  .panel {
    background: white;
    border-radius: 1rem;
    padding: 1.4rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: 0.25s;
  }
  .panel:hover {
    transform: translateY(-1px);
  }
  .chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
  .seccion h3 {
    font-weight: 600;
    color: var(--verde);
    margin-bottom: 0.4rem;
  }
  .subtitulo {
    color: #6b7280;
    font-size: 0.85rem;
  }
</style>
</head>

<body>
<header class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Historia Cl√≠nica Avanzada</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">‚Üê Volver al Panel</a>
</header>

<main class="grid grid-cols-1 xl:grid-cols-3 gap-8 p-6">
  <!-- PACIENTES -->
  <section class="panel overflow-y-auto max-h-[85vh]">
    <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="users"></i> Pacientes</h2>
    <input id="buscador" placeholder="Buscar por nombre o diagn√≥stico..." oninput="filtrarPacientes()" class="w-full p-2 mb-3 border rounded-md">
    <div id="listaPacientes"></div>
  </section>

  <!-- HISTORIA CL√çNICA -->
  <section class="xl:col-span-2 panel overflow-y-auto max-h-[85vh]">
    <div id="detallePaciente" class="text-center text-gray-400 italic">
      Selecciona un paciente para visualizar su historia cl√≠nica completa
    </div>
  </section>
</main>

<script>
lucide.createIcons();
const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let pacientes = [];

async function cargarPacientes() {
  const { data, error } = await supabase.from("pacientes").select("*").limit(200);
  if (error) return console.error(error);
  pacientes = data;
  renderPacientes(data);
}

function renderPacientes(lista) {
  const cont = document.getElementById("listaPacientes");
  cont.innerHTML = lista.map(p => `
    <div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer" onclick="verPaciente('${p.patient_id}')">
      <p class="font-medium">${p.nombre} ${p.apellido || ""}</p>
      <p class="text-xs text-gray-500">${p.edad} a√±os ‚Ä¢ ${p.enfermedad_principal || "Sin diagn√≥stico"}</p>
      <span class="chip ${p.IMC>30?'riesgo-alto':p.IMC>25?'riesgo-medio':'riesgo-bajo'}">IMC ${p.IMC}</span>
    </div>`).join("");
}

function filtrarPacientes() {
  const q = document.getElementById("buscador").value.toLowerCase();
  renderPacientes(pacientes.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

async function verPaciente(id) {
  const p = pacientes.find(x => x.patient_id === id);
  const [labs, meds, notas, diags] = await Promise.all([
    supabase.from("laboratorios").select("*").eq("patient_id", id),
    supabase.from("medicaciones").select("*").eq("patient_id", id),
    supabase.from("notas_clinicas").select("*").eq("patient_id", id),
    supabase.from("diagnosticos").select("*").eq("patient_id", id)
  ]);

  const promedioHb = avg(labs.data.map(x => x.HbA1c));
  const promedioTFG = avg(labs.data.map(x => x.TFG));
  const adherencia = avg(meds.data.map(x => x["adherencia_%"]));
  const riesgo = promedioHb>7||promedioTFG<60?"riesgo-alto":promedioHb>6?"riesgo-medio":"riesgo-bajo";

  document.getElementById("detallePaciente").innerHTML = `
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold text-[var(--verde)]">${p.nombre} ${p.apellido}</h2>
    <span class="chip ${riesgo}">${riesgo.replace("riesgo-","").toUpperCase()}</span>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-4">
    <div>
      <p><b>Edad:</b> ${p.edad}</p>
      <p><b>Sexo:</b> ${p.sexo}</p>
      <p><b>Actividad f√≠sica:</b> ${p.actividad_f√≠sica}</p>
      <p><b>Nivel educativo:</b> ${p.nivel_educativo}</p>
    </div>
    <div>
      <p><b>Diagn√≥stico principal:</b> ${p.enfermedad_principal}</p>
      <p><b>Fumador:</b> ${p.fumador}</p>
      <p><b>Nivel socioecon√≥mico:</b> ${p.nivel_socioecon√≥mico}</p>
      <p><b>IMC:</b> ${p.IMC}</p>
    </div>
  </div>

  <div class="seccion border-t pt-3">
    <h3><i data-lucide='thermometer'></i> Indicadores cl√≠nicos</h3>
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="panel"><p class="subtitulo">HbA1c media</p><p class="text-lg font-semibold">${promedioHb.toFixed(1)}%</p></div>
      <div class="panel"><p class="subtitulo">TFG media</p><p class="text-lg font-semibold">${promedioTFG.toFixed(0)}</p></div>
      <div class="panel"><p class="subtitulo">Adherencia media</p><p class="text-lg font-semibold">${adherencia.toFixed(1)}%</p></div>
    </div>
    <canvas id="graficoLabs" class="mt-4"></canvas>
  </div>

  <div class="seccion border-t pt-3 mt-4">
    <h3><i data-lucide='pill'></i> Medicaciones</h3>
    ${meds.data?.length ? `
      <table class="w-full text-sm mt-2">
        <tr class="text-gray-500 text-xs border-b"><th class="text-left">F√°rmaco</th><th>Dosis</th><th>Inicio</th><th>Adherencia</th></tr>
        ${meds.data.map(m=>`
          <tr class="border-b"><td>${m.principio_activo}</td><td>${m.dosis_diaria_mg} mg</td><td>${m.inicio_tratamiento||'-'}</td><td>${m["adherencia_%"]||'-'}%</td></tr>`).join("")}
      </table>
    `:"<p>No hay medicaciones registradas.</p>"}
  </div>

  <div class="seccion border-t pt-3 mt-4">
    <h3><i data-lucide='clipboard-heart'></i> Diagn√≥sticos</h3>
    ${diags.data?.length?diags.data.map(d=>`
      <p class="text-sm">üìã ${d.nombre_diagn√≥stico} (${d.CIE10_code}) ‚Äî ${d.estado||'-'}, ${d.gravedad||'-'}</p>`).join(""):"<p>No hay diagn√≥sticos registrados.</p>"}
  </div>

  <div class="seccion border-t pt-3 mt-4">
    <h3><i data-lucide='book-open-text'></i> Notas cl√≠nicas</h3>
    ${notas.data?.length?notas.data.slice(-5).map(n=>`
      <div class="border p-2 rounded-md mb-2 bg-gray-50">
        <p class="text-xs text-gray-500">${n.fecha_nota}</p>
        <p>${n.texto_nota}</p>
      </div>`).join(""):"<p>No hay notas recientes.</p>"}
  </div>
  `;

  lucide.createIcons();
  if(labs.data?.length) renderGraficoLabs(labs.data);
}

function avg(arr){return arr.filter(x=>x).reduce((a,b)=>a+b,0)/(arr.filter(x=>x).length||1)}

function renderGraficoLabs(data){
  const ctx = document.getElementById("graficoLabs");
  new Chart(ctx,{
    type:"line",
    data:{
      labels:data.map(l=>l.fecha_prueba),
      datasets:[
        {label:"HbA1c", data:data.map(l=>l.HbA1c), borderColor:"#f97316", tension:0.3},
        {label:"TFG", data:data.map(l=>l.TFG), borderColor:"#2563eb", tension:0.3, yAxisID:"y1"}
      ]
    },
    options:{
      responsive:true,
      scales:{
        y:{title:{display:true,text:"HbA1c (%)"}},
        y1:{position:"right",title:{display:true,text:"TFG (ml/min)"}}
      },
      plugins:{legend:{position:"bottom"}}
    }
  });
}

cargarPacientes();
</script>
</body>
</html>
