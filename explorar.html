<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Explorador Clínico</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  body { font-family: "Inter", sans-serif; background-color: #f5f3ef; color: #1f1f1f; }
  header { background: #1c1c1b; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
  .tab { cursor: pointer; padding: 0.8rem 1.2rem; border-bottom: 3px solid transparent; font-weight: 500; }
  .tab.active { border-color: #4a8c3f; color: #4a8c3f; font-weight: 600; }
  .card { background: white; border-radius: 0.8rem; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .row:hover { background-color: #f7f7f7; cursor: pointer; }
</style>
</head>

<body>
  <!-- Header superior -->
  <header>
    <div class="flex items-center gap-2">
      <i data-lucide="database" class="text-lime-400"></i>
      <h1 class="text-xl font-semibold">Explorador Clínico</h1>
    </div>
    <a href="index.html" class="text-sm underline text-lime-400 hover:text-lime-500">Volver al Panel</a>
  </header>

  <!-- Tabs -->
  <div class="flex border-b px-6 bg-white sticky top-0 z-10">
    <div class="tab active" onclick="cambiarTabla('pacientes')">Pacientes</div>
    <div class="tab" onclick="cambiarTabla('diagnosticos')">Diagnósticos</div>
    <div class="tab" onclick="cambiarTabla('laboratorios')">Laboratorios</div>
    <div class="tab" onclick="cambiarTabla('medicaciones')">Medicaciones</div>
    <div class="tab" onclick="cambiarTabla('notas_clinicas')">Notas Clínicas</div>
  </div>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-8">
    <!-- Lista -->
    <section class="col-span-1">
      <input id="buscador" placeholder="Buscar..." oninput="filtrar()" class="w-full p-2 border border-stone-300 rounded-md mb-4">
      <div id="lista" class="bg-white rounded-md shadow divide-y overflow-y-auto" style="max-height:75vh;"></div>
    </section>

    <!-- Detalle -->
    <section class="col-span-2">
      <div id="detalle" class="hidden card">
        <h2 class="text-xl font-semibold mb-2" id="tituloDetalle"></h2>
        <div id="contenidoDetalle" class="text-sm text-stone-700"></div>
      </div>
      <div id="sinSeleccion" class="text-stone-500 italic text-center mt-20">
        Selecciona un registro para ver más detalles
      </div>
    </section>
  </main>

  <script>
  lucide.createIcons();
  const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let tablaActual = "pacientes";
  let registros = [];

  async function cambiarTabla(nombre) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[onclick="cambiarTabla('${nombre}')"]`).classList.add("active");
    tablaActual = nombre;
    document.getElementById("buscador").value = "";
    cargarLista();
    document.getElementById("detalle").classList.add("hidden");
    document.getElementById("sinSeleccion").classList.remove("hidden");
  }

  async function cargarLista() {
    const cont = document.getElementById("lista");
    cont.innerHTML = "<p class='p-4 text-stone-500 italic'>Cargando...</p>";
    const { data, error } = await supabase.from(tablaActual).select("*").limit(100);
    if (error) {
      cont.innerHTML = "<p class='p-4 text-red-600'>Error al cargar datos.</p>";
      console.error(error);
      return;
    }
    registros = data;
    renderLista(data);
  }

  function renderLista(lista) {
    const cont = document.getElementById("lista");
    if (!lista.length) {
      cont.innerHTML = "<p class='p-4 text-stone-500 italic'>No hay registros.</p>";
      return;
    }
    cont.innerHTML = lista.map(r => {
      let titulo = "", subtitulo = "";
      if (tablaActual === "pacientes") {
        titulo = `${r.nombre || ""} ${r.apellido || ""}`;
        subtitulo = `${r.enfermedad_principal || "Sin enfermedad"} • ${r.edad || "-"} años`;
      } else if (tablaActual === "diagnosticos") {
        titulo = r.nombre_diagnóstico || r.CIE10_code;
        subtitulo = r.estado || "Sin estado";
      } else if (tablaActual === "laboratorios") {
        titulo = r.fecha_prueba || "Sin fecha";
        subtitulo = `HbA1c: ${r.HbA1c || "-"}, TFG: ${r.TFG || "-"}`;
      } else if (tablaActual === "medicaciones") {
        titulo = r.principio_activo || "Sin principio activo";
        subtitulo = `Dosis: ${r.dosis_diaria_mg || "-"} mg/día`;
      } else if (tablaActual === "notas_clinicas") {
        titulo = r.fecha_nota || "Sin fecha";
        subtitulo = (r.texto_nota || "").slice(0,60) + "...";
      }
      return `
        <div class="row p-4" onclick="mostrarDetalle('${r[Object.keys(r)[0]]}')">
          <p class="font-medium">${titulo}</p>
          <p class="text-xs text-stone-500">${subtitulo}</p>
        </div>`;
    }).join("");
  }

  function filtrar() {
    const q = document.getElementById("buscador").value.toLowerCase();
    renderLista(registros.filter(r => JSON.stringify(r).toLowerCase().includes(q)));
  }

  function mostrarDetalle(id) {
    const reg = registros.find(r => r[Object.keys(r)[0]] == id);
    if (!reg) return;
    document.getElementById("sinSeleccion").classList.add("hidden");
    document.getElementById("detalle").classList.remove("hidden");

    document.getElementById("tituloDetalle").textContent = tablaActual.charAt(0).toUpperCase() + tablaActual.slice(1);
    document.getElementById("contenidoDetalle").innerHTML =
      Object.entries(reg).map(([k,v]) => `
        <p><b>${k}:</b> ${v !== null ? v : "-"}</p>
      `).join("");
  }

  cargarLista();
  </script>
</body>
</html>
