<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Explorador Clínico</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #3d7658;
    --verde-claro: #4ba67d;
    --gris-fondo: #f8f9f8;
  }

  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }

  header {
    background: white;
    border-bottom: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }

  .tab {
    cursor: pointer;
    padding: 0.8rem 1.4rem;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: 0.25s;
  }

  .tab.active {
    border-color: var(--verde);
    color: var(--verde);
    font-weight: 600;
  }

  .card {
    background: white;
    border-radius: 0.8rem;
    padding: 1.2rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    transition: all 0.25s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }

  .btn {
    background: var(--verde);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.4rem;
    font-weight: 500;
    transition: 0.2s;
  }

  .btn:hover {
    background: var(--verde-claro);
  }

  .row:hover {
    background-color: #f3f4f6;
  }

  .stat {
    background: white;
    border-radius: 0.8rem;
    padding: 1rem 1.4rem;
    text-align: center;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
</style>
</head>

<body>
  <!-- HEADER -->
  <header class="flex justify-between items-center px-8 py-4">
    <div class="flex items-center gap-2">
      <i data-lucide="activity" class="text-[var(--verde)]"></i>
      <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
      <span class="text-gray-500 text-sm">Explorador Clínico</span>
    </div>
    <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
  </header>

  <!-- PESTAÑAS -->
  <div class="flex border-b bg-white sticky top-0 z-10">
    <div class="tab active" onclick="cambiarTabla('pacientes')">Pacientes</div>
    <div class="tab" onclick="cambiarTabla('laboratorios')">Laboratorios</div>
    <div class="tab" onclick="cambiarTabla('medicaciones')">Medicaciones</div>
    <div class="tab" onclick="cambiarTabla('notas_clinicas')">Notas Clínicas</div>
  </div>

  <main class="p-8 grid grid-cols-1 xl:grid-cols-3 gap-8">
    <!-- FILTROS + LISTA -->
    <section class="col-span-1">
      <div class="card mb-4">
        <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2">
          <i data-lucide="filter"></i> Filtros rápidos
        </h2>
        <div class="flex flex-col gap-3">
          <input id="buscador" placeholder="Buscar paciente, diagnóstico..." oninput="filtrar()"
            class="w-full p-2 border border-gray-300 rounded-md">
          <div id="filtroRangoEdad" class="hidden flex gap-2">
            <input id="edadMin" type="number" placeholder="Edad mínima" class="w-1/2 border p-2 rounded-md" oninput="filtrar()">
            <input id="edadMax" type="number" placeholder="Edad máxima" class="w-1/2 border p-2 rounded-md" oninput="filtrar()">
          </div>
          <div id="filtroFecha" class="hidden flex gap-2">
            <input id="fechaInicio" type="date" class="border p-2 rounded-md w-1/2" onchange="filtrarNotas()">
            <input id="fechaFin" type="date" class="border p-2 rounded-md w-1/2" onchange="filtrarNotas()">
          </div>
        </div>
      </div>

      <div id="lista" class="bg-white rounded-md shadow divide-y overflow-y-auto" style="max-height:70vh;"></div>
    </section>

    <!-- DETALLE Y ESTADÍSTICAS -->
    <section class="col-span-2">
      <div id="estadisticas" class="grid grid-cols-3 gap-4 mb-5 hidden"></div>

      <div id="detalle" class="hidden card">
        <h2 class="text-xl font-semibold mb-2" id="tituloDetalle"></h2>
        <div id="contenidoDetalle" class="text-sm text-gray-700"></div>
      </div>

      <div id="sinSeleccion" class="text-gray-400 italic text-center mt-20">
        Selecciona un registro o aplica filtros para comenzar la exploración
      </div>
    </section>
  </main>

  <script>
  lucide.createIcons();

  const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let tablaActual = "pacientes";
  let registros = [];

  async function cambiarTabla(nombre) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[onclick="cambiarTabla('${nombre}')"]`).classList.add("active");
    tablaActual = nombre;
    document.getElementById("filtroRangoEdad").classList.toggle("hidden", nombre !== "pacientes");
    document.getElementById("filtroFecha").classList.toggle("hidden", nombre !== "notas_clinicas");
    document.getElementById("detalle").classList.add("hidden");
    document.getElementById("estadisticas").classList.add("hidden");
    document.getElementById("sinSeleccion").classList.remove("hidden");
    cargarLista();
  }

  async function cargarLista() {
    const cont = document.getElementById("lista");
    cont.innerHTML = "<p class='p-4 text-gray-400 italic'>Cargando...</p>";
    const { data, error } = await supabase.from(tablaActual).select("*");
    if (error) { cont.innerHTML = "<p class='p-4 text-red-600'>Error al cargar datos.</p>"; return; }
    registros = data;
    renderLista(registros);
  }

  function renderLista(lista) {
    const cont = document.getElementById("lista");
    if (!lista.length) {
      cont.innerHTML = "<p class='p-4 text-gray-400 italic'>No hay registros.</p>";
      return;
    }

    if (tablaActual === "pacientes") {
      cont.innerHTML = lista.map(p => `
        <div class="row p-4 border-b" onclick="mostrarDetalle('${p.patient_id}')">
          <p class="font-medium">${p.nombre} ${p.apellido || ""}</p>
          <p class="text-xs text-gray-500">${p.edad || "-"} años • ${p.enfermedad_principal || "Sin diagnóstico"}</p>
        </div>`).join("");
    }

    if (tablaActual === "laboratorios") {
      cont.innerHTML = lista.map(l => `
        <div class="row p-4 border-b" onclick="mostrarDetalle('${l.lab_id}')">
          <p class="font-medium">${l.fecha_prueba}</p>
          <p class="text-xs text-gray-500">HbA1c: ${l.HbA1c || "-"} • TFG: ${l.TFG || "-"}</p>
        </div>`).join("");
    }

    if (tablaActual === "medicaciones") {
      const agrupadas = {};
      lista.forEach(m => {
        const med = m.principio_activo || "Desconocido";
        if (!agrupadas[med]) agrupadas[med] = [];
        agrupadas[med].push(m);
      });
      cont.innerHTML = Object.entries(agrupadas).map(([med, arr]) => `
        <div class="row p-4 border-b" onclick="mostrarDetalle('${med}')">
          <p class="font-medium">${med}</p>
          <p class="text-xs text-gray-500">${arr.length} pacientes</p>
        </div>`).join("");
    }

    if (tablaActual === "notas_clinicas") {
      cont.innerHTML = lista.sort((a,b)=>new Date(b.fecha_nota)-new Date(a.fecha_nota))
        .map(n => `
        <div class="row p-4 border-b" onclick="mostrarDetalle('${n.note_id}')">
          <p class="font-medium">${n.fecha_nota}</p>
          <p class="text-xs text-gray-500">${(n.texto_nota||"").slice(0,60)}...</p>
        </div>`).join("");
    }
  }

  function filtrar() {
    const q = document.getElementById("buscador").value.toLowerCase();
    const edadMin = +document.getElementById("edadMin")?.value || 0;
    const edadMax = +document.getElementById("edadMax")?.value || 150;
    let filtrados = registros.filter(r => JSON.stringify(r).toLowerCase().includes(q));
    if (tablaActual === "pacientes") filtrados = filtrados.filter(p => p.edad >= edadMin && p.edad <= edadMax);
    renderLista(filtrados);
  }

  function filtrarNotas() {
    const inicio = document.getElementById("fechaInicio").value;
    const fin = document.getElementById("fechaFin").value;
    const filtradas = registros.filter(r => {
      const f = new Date(r.fecha_nota);
      return (!inicio || f >= new Date(inicio)) && (!fin || f <= new Date(fin));
    });
    renderLista(filtradas);
  }

  async function mostrarDetalle(id) {
    document.getElementById("detalle").classList.remove("hidden");
    document.getElementById("sinSeleccion").classList.add("hidden");

    const detalle = document.getElementById("contenidoDetalle");
    const titulo = document.getElementById("tituloDetalle");
    const stats = document.getElementById("estadisticas");

    if (tablaActual === "pacientes") {
      const p = registros.find(x => x.patient_id === id);
      titulo.textContent = `${p.nombre} ${p.apellido}`;
      const [labs, meds] = await Promise.all([
        supabase.from("laboratorios").select("*").eq("patient_id", id),
        supabase.from("medicaciones").select("*").eq("patient_id", id)
      ]);
      detalle.innerHTML = `
        <p><b>Edad:</b> ${p.edad} años</p>
        <p><b>Sexo:</b> ${p.sexo}</p>
        <p><b>IMC:</b> ${p.IMC}</p>
        <p><b>Diagnóstico principal:</b> ${p.enfermedad_principal}</p>
        <hr class="my-3">
        <h3 class="font-semibold text-[var(--verde)] mb-2">Últimas pruebas</h3>
        ${labs.data?.slice(0,3).map(l => `<p>${l.fecha_prueba}: HbA1c ${l.HbA1c}, TFG ${l.TFG}</p>`).join("") || "<p>No hay datos</p>"}
        <hr class="my-3">
        <h3 class="font-semibold text-[var(--verde)] mb-2">Tratamientos activos</h3>
        ${meds.data?.map(m => `<p>${m.principio_activo} (${m.dosis_diaria_mg} mg)</p>`).join("") || "<p>Sin medicaciones</p>"}
      `;
    }

    if (tablaActual === "laboratorios") {
      const lista = registros;
      const mediaHb = (lista.reduce((a,b)=>a+(+b.HbA1c||0),0)/lista.length).toFixed(2);
      const mediaTFG = (lista.reduce((a,b)=>a+(+b.TFG||0),0)/lista.length).toFixed(1);
      stats.innerHTML = `
        <div class="stat"><h4 class="text-sm text-gray-500">Media HbA1c</h4><p class="text-lg font-semibold text-[var(--verde)]">${mediaHb}</p></div>
        <div class="stat"><h4 class="text-sm text-gray-500">Media TFG</h4><p class="text-lg font-semibold text-[var(--verde)]">${mediaTFG}</p></div>
        <div class="stat"><h4 class="text-sm text-gray-500">Pruebas totales</h4><p class="text-lg font-semibold text-[var(--verde)]">${lista.length}</p></div>`;
      stats.classList.remove("hidden");
      titulo.textContent = "Resumen de Laboratorios";
      detalle.innerHTML = lista.slice(0,10).map(l => `
        <p>📅 ${l.fecha_prueba} — HbA1c: ${l.HbA1c}, TFG: ${l.TFG}</p>`).join("");
    }

    if (tablaActual === "medicaciones") {
      const grupo = registros.filter(m => m.principio_activo === id);
      titulo.textContent = `Pacientes tratados con ${id}`;
      detalle.innerHTML = grupo.map(p => `<p>${p.patient_id} — ${p.dosis_diaria_mg} mg/día</p>`).join("");
    }

    if (tablaActual === "notas_clinicas") {
      const n = registros.find(x => x.note_id === id);
      titulo.textContent = `Nota clínica - ${n.fecha_nota}`;
      detalle.innerHTML = `<p>${n.texto_nota}</p>`;
    }
  }

  cargarLista();
  </script>
</body>
</html>
