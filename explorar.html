<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Historia Clínica Avanzada</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }
  .panel {
    background: white;
    border-radius: 0.9rem;
    padding: 1.2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: 0.25s;
  }
  .panel:hover { transform: translateY(-1px); }
  .chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
</style>
</head>

<body>
<header class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Historia Clínica</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
</header>

<main class="grid grid-cols-1 xl:grid-cols-3 gap-8 p-6">
  <!-- PACIENTES -->
  <section class="panel overflow-y-auto max-h-[85vh]">
    <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="users"></i> Pacientes</h2>
    <input id="buscador" placeholder="Buscar..." oninput="filtrarPacientes()" class="w-full p-2 mb-3 border rounded-md">
    <div id="listaPacientes"></div>
  </section>

  <!-- HISTORIA CLÍNICA -->
  <section class="xl:col-span-2 panel overflow-y-auto max-h-[85vh]">
    <div id="detallePaciente" class="text-center text-gray-400 italic">
      Selecciona un paciente para visualizar su historia clínica completa
    </div>
  </section>
</main>

<script>
lucide.createIcons();

const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let pacientes = [];

async function cargarPacientes() {
  const { data } = await supabase.from("pacientes").select("*").limit(200);
  pacientes = data;
  renderPacientes(data);
}

function renderPacientes(lista) {
  const cont = document.getElementById("listaPacientes");
  cont.innerHTML = lista.map(p => `
    <div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer" onclick="verPaciente('${p.patient_id}')">
      <p class="font-medium">${p.nombre} ${p.apellido || ""}</p>
      <p class="text-xs text-gray-500">${p.edad} años • ${p.enfermedad_principal || "Sin diagnóstico"}</p>
      <span class="chip ${p.IMC>30?'riesgo-alto':p.IMC>25?'riesgo-medio':'riesgo-bajo'}">IMC ${p.IMC}</span>
    </div>`).join("");
}

function filtrarPacientes() {
  const q = document.getElementById("buscador").value.toLowerCase();
  renderPacientes(pacientes.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

async function verPaciente(id) {
  const p = pacientes.find(x => x.patient_id === id);
  const [labs, meds, notas, diags] = await Promise.all([
    supabase.from("laboratorios").select("*").eq("patient_id", id),
    supabase.from("medicaciones").select("*").eq("patient_id", id),
    supabase.from("notas_clinicas").select("*").eq("patient_id", id),
    supabase.from("diagnosticos").select("*").eq("patient_id", id)
  ]);

  const promedioHb = avg(labs.data.map(x => x.HbA1c));
  const promedioTFG = avg(labs.data.map(x => x.TFG));
  const colesterol = avg(labs.data.map(x => x.colesterol_total));
  const creatinina = avg(labs.data.map(x => x.creatinina));
  const adherencia = avg(meds.data.map(x => x["adherencia_%"]));
  const riesgo = promedioHb>7||promedioTFG<60?"riesgo-alto":promedioHb>6?"riesgo-medio":"riesgo-bajo";

  document.getElementById("detallePaciente").innerHTML = `
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold text-[var(--verde)]">${p.nombre} ${p.apellido}</h2>
    <span class="chip ${riesgo}">${riesgo.replace("riesgo-","").toUpperCase()}</span>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
    <div>
      <p><b>Edad:</b> ${p.edad}</p>
      <p><b>Sexo:</b> ${p.sexo}</p>
      <p><b>Actividad física:</b> ${p.actividad_física}</p>
      <p><b>IMC:</b> ${p.IMC}</p>
    </div>
    <div>
      <p><b>Diagnóstico principal:</b> ${p.enfermedad_principal}</p>
      <p><b>Fumador:</b> ${p.fumador}</p>
      <p><b>Nivel socioeconómico:</b> ${p.nivel_socioeconómico}</p>
      <p><b>Educación:</b> ${p.nivel_educativo}</p>
    </div>
  </div>

  <div class="overflow-x-auto">
    <div class="flex gap-4">
      <canvas id="graficoLabs" width="300" height="200"></canvas>
      <canvas id="graficoExtra" width="300" height="200"></canvas>
    </div>
  </div>

  <div class="mt-5">
    <h3 class="font-semibold text-[var(--verde)] mb-2">Indicadores Clínicos</h3>
    <div class="grid grid-cols-5 gap-3 text-center text-sm">
      <div class="panel"><p class="text-gray-500">HbA1c media</p><p class="text-lg font-semibold">${promedioHb.toFixed(1)}%</p></div>
      <div class="panel"><p class="text-gray-500">TFG media</p><p class="text-lg font-semibold">${promedioTFG.toFixed(0)}</p></div>
      <div class="panel"><p class="text-gray-500">Colesterol</p><p class="text-lg font-semibold">${colesterol.toFixed(0)}</p></div>
      <div class="panel"><p class="text-gray-500">Creatinina</p><p class="text-lg font-semibold">${creatinina.toFixed(2)}</p></div>
      <div class="panel"><p class="text-gray-500">Adherencia</p><p class="text-lg font-semibold">${adherencia.toFixed(1)}%</p></div>
    </div>
  </div>
  `;

  lucide.createIcons();
  if(labs.data?.length) {
    renderGraficoLabs(labs.data);
    renderGraficoExtra(labs.data);
  }
}

function avg(arr){return arr.filter(x=>x).reduce((a,b)=>a+b,0)/(arr.filter(x=>x).length||1)}

function renderGraficoLabs(data){
  const ctx = document.getElementById("graficoLabs");
  new Chart(ctx,{
    type:"line",
    data:{
      labels:data.map(l=>l.fecha_prueba),
      datasets:[
        {label:"HbA1c", data:data.map(l=>l.HbA1c), borderColor:"#f97316", tension:0.3},
        {label:"TFG", data:data.map(l=>l.TFG), borderColor:"#2563eb", tension:0.3, yAxisID:"y1"}
      ]
    },
    options:{
      scales:{ y:{title:{display:true,text:"HbA1c"}}, y1:{position:"right",title:{display:true,text:"TFG"}} },
      plugins:{legend:{display:false}}
    }
  });
}

function renderGraficoExtra(data){
  const ctx = document.getElementById("graficoExtra");
  new Chart(ctx,{
    type:"bar",
    data:{
      labels:data.map(l=>l.fecha_prueba),
      datasets:[
        {label:"Colesterol", data:data.map(l=>l.colesterol_total), backgroundColor:"#4aba84"},
        {label:"Triglicéridos", data:data.map(l=>l.triglicéridos), backgroundColor:"#94a3b8"}
      ]
    },
    options:{
      scales:{ y:{title:{display:true,text:"mg/dL"}} },
      plugins:{legend:{position:"bottom"}}
    }
  });
}

cargarPacientes();
</script>
</body>
</html>
