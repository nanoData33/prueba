<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Explorador Clínico Avanzado</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-bottom: 1px solid #e5e7eb;
  }
  .tab {
    cursor: pointer;
    padding: 0.8rem 1.4rem;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: 0.25s;
  }
  .tab.active {
    border-color: var(--verde);
    color: var(--verde);
    font-weight: 600;
  }
  .panel {
    background: white;
    border-radius: 0.9rem;
    padding: 1.2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: 0.25s;
  }
  .panel:hover { transform: translateY(-1px); }
  .chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Explorador Clínico</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
</header>

<!-- Pestañas -->
<div class="flex border-b bg-white sticky top-0 z-10">
  <div class="tab active" onclick="cambiarVista('pacientes')">Pacientes</div>
  <div class="tab" onclick="cambiarVista('laboratorios')">Laboratorios</div>
  <div class="tab" onclick="cambiarVista('medicaciones')">Medicaciones</div>
</div>

<main id="contenedor" class="p-6"></main>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Explorador Clínico Avanzado</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body {
    font-family: "Inter", sans-serif;
    background-color: var(--gris-fondo);
  }
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-bottom: 1px solid #e5e7eb;
  }
  .tab {
    cursor: pointer;
    padding: 0.8rem 1.4rem;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: 0.25s;
  }
  .tab.active {
    border-color: var(--verde);
    color: var(--verde);
    font-weight: 600;
  }
  .panel {
    background: white;
    border-radius: 0.9rem;
    padding: 1.2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: 0.25s;
  }
  .panel:hover { transform: translateY(-1px); }
  .chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Explorador Clínico</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
</header>

<!-- Pestañas -->
<div class="flex border-b bg-white sticky top-0 z-10">
  <div class="tab active" onclick="cambiarVista('pacientes')">Pacientes</div>
  <div class="tab" onclick="cambiarVista('laboratorios')">Laboratorios</div>
  <div class="tab" onclick="cambiarVista('medicaciones')">Medicaciones</div>
</div>

<main id="contenedor" class="p-6"></main>

<script>
lucide.createIcons();

const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let vistaActual = "pacientes";
let chartLabs, chartExtra;

// Cambiar pestañas
function cambiarVista(vista) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[onclick="cambiarVista('${vista}')"]`).classList.add("active");
  vistaActual = vista;
  if (vista === "pacientes") cargarPacientes();
  if (vista === "laboratorios") cargarLaboratorios();
  if (vista === "medicaciones") cargarMedicaciones();
}

/* ==========================
   1. PACIENTES
========================== */
async function cargarPacientes() {
  const { data } = await supabase.from("pacientes").select("*").limit(100);
  const cont = document.getElementById("contenedor");
  cont.innerHTML = `
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <section class="panel">
      <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="users"></i> Pacientes</h2>
      <input id="buscador" placeholder="Buscar..." oninput="filtrarPacientes()" class="w-full p-2 mb-3 border rounded-md">
      <div id="listaPacientes"></div>
    </section>
    <section class="xl:col-span-2 panel overflow-y-auto max-h-[80vh]" id="detallePaciente">
      <p class="text-center text-gray-400 italic">Selecciona un paciente para ver detalles</p>
    </section>
  </div>`;
  lucide.createIcons();
  window.pacientes = data;
  renderPacientes(data);

  // Si hay un paciente en la URL, cargarlo
  const params = new URLSearchParams(window.location.search);
  const id = params.get("paciente");
  if (id) verPaciente(id);
}

function renderPacientes(lista) {
  const cont = document.getElementById("listaPacientes");
  cont.innerHTML = lista.map(p => `
    <div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer flex justify-between items-center" onclick="verPaciente('${p.patient_id}', true)">
      <div>
        <p class="font-medium">${p.nombre} ${p.apellido || ""}</p>
        <p class="text-xs text-gray-500">${p.edad} años • ${p.enfermedad_principal || "Sin diagnóstico"}</p>
      </div>
      <span class="chip ${p.IMC>30?'riesgo-alto':p.IMC>25?'riesgo-medio':'riesgo-bajo'}">IMC ${p.IMC}</span>
    </div>`).join("");
}
function filtrarPacientes() {
  const q = document.getElementById("buscador").value.toLowerCase();
  renderPacientes(pacientes.filter(p => JSON.stringify(p).toLowerCase().includes(q)));
}

async function verPaciente(id, cambiarUrl=false) {
  if (cambiarUrl) {
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("paciente", id);
    window.history.pushState({}, "", newUrl);
  }

  const p = pacientes.find(x => x.patient_id === id);
  const [labs, meds] = await Promise.all([
    supabase.from("laboratorios").select("*").eq("patient_id", id),
    supabase.from("medicaciones").select("*").eq("patient_id", id)
  ]);
  const labData = labs.data || [];
  const promedioHb = avg(labData.map(x => x.HbA1c));
  const promedioTFG = avg(labData.map(x => x.TFG));
  const riesgo = promedioHb>7||promedioTFG<60?"riesgo-alto":promedioHb>6?"riesgo-medio":"riesgo-bajo";

  document.getElementById("detallePaciente").innerHTML = `
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold text-[var(--verde)]">${p.nombre} ${p.apellido}</h2>
    <span class="chip ${riesgo}">${riesgo.replace("riesgo-","").toUpperCase()}</span>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
    <div>
      <p><b>Edad:</b> ${p.edad}</p>
      <p><b>Sexo:</b> ${p.sexo}</p>
      <p><b>Actividad física:</b> ${p.actividad_física}</p>
      <p><b>IMC:</b> ${p.IMC}</p>
    </div>
    <div>
      <p><b>Diagnóstico principal:</b> ${p.enfermedad_principal}</p>
      <p><b>Fumador:</b> ${p.fumador}</p>
      <p><b>Nivel socioeconómico:</b> ${p.nivel_socioeconómico}</p>
      <p><b>Educación:</b> ${p.nivel_educativo}</p>
    </div>
  </div>

  <div class="flex flex-col gap-6">
    <div class="panel"><canvas id="graficoLabs"></canvas></div>
    <div class="panel"><canvas id="graficoExtra"></canvas></div>
  </div>`;
  renderGraficoLabs(labData);
  renderGraficoExtra(labData);
}

/* ==========================
   2. LABORATORIOS
========================== */
async function cargarLaboratorios() {
  const { data } = await supabase.from("laboratorios").select("*").limit(200);
  const cont = document.getElementById("contenedor");
  const mediaHb = avg(data.map(x=>x.HbA1c));
  const mediaTFG = avg(data.map(x=>x.TFG));
  cont.innerHTML = `
  <div class="panel mb-6">
    <h2 class="text-lg font-semibold text-[var(--verde)] mb-2">Tendencia global de laboratorio</h2>
    <canvas id="graficoLabGlobal" height="260"></canvas>
  </div>`;
  renderGraficoLabGlobal(data);
}

/* ==========================
   3. MEDICACIONES
========================== */
async function cargarMedicaciones() {
  const { data } = await supabase.from("medicaciones").select("*").limit(200);
  const cont = document.getElementById("contenedor");
  cont.innerHTML = `
  <div class="panel">
    <h2 class="font-semibold text-[var(--verde)] mb-3"><i data-lucide="pill"></i> Medicaciones</h2>
    <canvas id="graficoMedGlobal"></canvas>
  </div>`;
  renderGraficoMedGlobal(data);
}

/* ==========================
   Gráficos mejorados
========================== */
function avg(arr){return arr.filter(x=>x).reduce((a,b)=>a+b,0)/(arr.filter(x=>x).length||1)}

function renderGraficoLabs(data){
  const ctx=document.getElementById("graficoLabs");
  if(chartLabs)chartLabs.destroy();
  chartLabs=new Chart(ctx,{type:"line",data:{
    labels:data.map(l=>l.fecha_prueba),
    datasets:[
      {label:"HbA1c (%)",data:data.map(l=>l.HbA1c),borderColor:"#e76f51",tension:0.35,fill:false},
      {label:"TFG (ml/min)",data:data.map(l=>l.TFG),borderColor:"#2a9d8f",tension:0.35,fill:false,yAxisID:"y1"}
    ]},
    options:{responsive:true,interaction:{mode:"index",intersect:false},
      plugins:{legend:{position:"top"},title:{display:true,text:"Evolución HbA1c y TFG"}},
      scales:{y:{title:{display:true,text:"HbA1c (%)"}},y1:{position:"right",title:{display:true,text:"TFG"}}}}
  });
}

function renderGraficoExtra(data){
  const ctx=document.getElementById("graficoExtra");
  if(chartExtra)chartExtra.destroy();
  chartExtra=new Chart(ctx,{type:"bar",data:{
    labels:data.map(l=>l.fecha_prueba),
    datasets:[
      {label:"Colesterol total (mg/dL)",data:data.map(l=>l.colesterol_total),backgroundColor:"#4aba84"},
      {label:"Triglicéridos (mg/dL)",data:data.map(l=>l.triglicéridos),backgroundColor:"#f4a261"}
    ]},
    options:{responsive:true,plugins:{legend:{position:"top"},title:{display:true,text:"Perfil lipídico"}}}
  });
}

function renderGraficoLabGlobal(data){
  new Chart(document.getElementById("graficoLabGlobal"),{
    type:"scatter",
    data:{datasets:[{label:"Relación HbA1c-TFG",data:data.map(d=>({x:d.HbA1c,y:d.TFG})),backgroundColor:"#2b7a58"}]},
    options:{plugins:{legend:{display:true}},scales:{x:{title:{display:true,text:"HbA1c"}},y:{title:{display:true,text:"TFG"}}}}
  });
}

function renderGraficoMedGlobal(data){
  const medsCount={};
  data.forEach(m=>medsCount[m.principio_activo]=(medsCount[m.principio_activo]||0)+1);
  new Chart(document.getElementById("graficoMedGlobal"),{
    type:"bar",
    data:{labels:Object.keys(medsCount),datasets:[{label:"Pacientes tratados",data:Object.values(medsCount),backgroundColor:"#4aba84"}]},
    options:{indexAxis:"y",plugins:{legend:{display:false},title:{display:true,text:"Medicaciones más frecuentes"}}}
  });
}

cambiarVista("pacientes");
</script>
</body>
</html>
