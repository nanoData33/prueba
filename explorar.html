<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortLab — Explorador Clínico Avanzado</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #4aba84;
    --gris-fondo: #f6f7f6;
  }
  body { font-family: "Inter", sans-serif; background-color: var(--gris-fondo); }
  header { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-bottom: 1px solid #e5e7eb; }
  .tab { cursor: pointer; padding: 0.8rem 1.4rem; border-bottom: 3px solid transparent; font-weight: 500; transition: 0.25s; }
  .tab.active { border-color: var(--verde); color: var(--verde); font-weight: 600; }
  .panel { background: white; border-radius: 0.9rem; padding: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.25s; }
  .panel:hover { transform: translateY(-1px); }
  .chip { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
  .chip.riesgo-alto { background: #fee2e2; color: #991b1b; }
  .chip.riesgo-medio { background: #fef9c3; color: #92400e; }
  .chip.riesgo-bajo { background: #dcfce7; color: #166534; }
  .btn { background: var(--verde); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; }
  .btn:hover { background: var(--verde-claro); }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortLab</h1>
    <span class="text-gray-500 text-sm">Explorador Clínico</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al Panel</a>
</header>

<div class="flex border-b bg-white sticky top-0 z-10">
  <div class="tab active" onclick="cambiarVista('pacientes')">Pacientes</div>
  <div class="tab" onclick="cambiarVista('medicaciones')">Medicaciones</div>
</div>

<main id="contenedor" class="p-6"></main>

<script>
lucide.createIcons();

const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let charts = [];

function cambiarVista(vista){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(`.tab[onclick="cambiarVista('${vista}')"]`).classList.add("active");
  charts.forEach(c=>c.destroy?.());
  if(vista==="pacientes") cargarPacientes();
  if(vista==="laboratorios") cargarLaboratorios();
  if(vista==="medicaciones") cargarMedicaciones();
}

/* -------------------- PACIENTES -------------------- */
async function cargarPacientes(){
  const { data: pacientes } = await supabase.from("pacientes").select("*").limit(100);
  const cont=document.getElementById("contenedor");
  cont.innerHTML=`
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <section class="panel">
      <h2 class="font-semibold text-[var(--verde)] mb-3 flex items-center gap-2"><i data-lucide="users"></i> Pacientes</h2>
      <input id="buscador" placeholder="Buscar..." oninput="filtrarPacientes()" class="w-full p-2 mb-3 border rounded-md">
      <div id="listaPacientes"></div>
    </section>
    <section class="xl:col-span-2 panel overflow-y-auto max-h-[85vh]" id="detallePaciente">
      <p class="text-center text-gray-400 italic">Selecciona un paciente para ver detalles</p>
    </section>
  </div>`;
  window.pacientes=pacientes; renderPacientes(pacientes);
  const id=new URLSearchParams(window.location.search).get("paciente"); if(id) verPaciente(id);
}

function renderPacientes(lista){
  const cont=document.getElementById("listaPacientes");
  cont.innerHTML=lista.map(p=>`
    <div class="p-3 mb-2 border rounded-md hover:bg-gray-50 cursor-pointer flex justify-between items-center" onclick="verPaciente('${p.patient_id}',true)">
      <div>
        <p class="font-medium">${p.nombre} ${p.apellido||""}</p>
        <p class="text-xs text-gray-500">${p.edad} años • ${p.enfermedad_principal||"Sin diagnóstico"}</p>
      </div>
      <span class="chip ${p.IMC>30?'riesgo-alto':p.IMC>25?'riesgo-medio':'riesgo-bajo'}">IMC ${p.IMC}</span>
    </div>`).join("");
}
function filtrarPacientes(){const q=document.getElementById("buscador").value.toLowerCase();renderPacientes(pacientes.filter(p=>JSON.stringify(p).toLowerCase().includes(q)));}

async function verPaciente(id,cambiarUrl=false){
  if(cambiarUrl){const u=new URL(window.location.href);u.searchParams.set("paciente",id);window.history.pushState({}, "", u);}
  const [p,labs,diags,notas,contacto,seg]=await Promise.all([
    supabase.from("pacientes").select("*").eq("patient_id",id).single(),
    supabase.from("laboratorios").select("*").eq("patient_id",id).order("fecha_prueba",{ascending:true}),
    supabase.from("diagnosticos").select("*").eq("patient_id",id),
    supabase.from("notas_clinicas").select("*").eq("patient_id",id).order("fecha_nota",{ascending:false}).limit(3),
    supabase.from("paciente_contacto").select("*").eq("patient_id",id).single(),
    supabase.from("seguimiento_pacientes").select("*").eq("patient_id",id).single()
  ]);
  const labData=labs.data||[]; const promedioHb=avg(labData.map(x=>x.HbA1c)); const promedioTFG=avg(labData.map(x=>x.TFG));
  const riesgo=promedioHb>7||promedioTFG<60?"riesgo-alto":promedioHb>6?"riesgo-medio":"riesgo-bajo";
  const c=document.getElementById("detallePaciente");
  c.innerHTML=`
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold text-[var(--verde)]">${p.data.nombre} ${p.data.apellido}</h2>
    <span class="chip ${riesgo}">${riesgo.replace("riesgo-","").toUpperCase()}</span>
  </div>
  <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
    <div>
      <p><b>Edad:</b> ${p.data.edad}</p><p><b>Sexo:</b> ${p.data.sexo}</p><p><b>Actividad:</b> ${p.data.actividad_física}</p><p><b>IMC:</b> ${p.data.IMC}</p>
    </div><div>
      <p><b>Diagnóstico:</b> ${p.data.enfermedad_principal}</p><p><b>Fumador:</b> ${p.data.fumador}</p><p><b>Socioeconómico:</b> ${p.data.nivel_socioeconómico}</p>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-4 mb-6"><div class="panel"><canvas id="graficoLabs"></canvas></div><div class="panel"><canvas id="graficoExtra"></canvas></div></div>
  <div><h3 class="font-semibold text-[var(--verde)] mb-2">Notas Clínicas</h3>${(notas.data||[]).map(n=>`<div class="border p-2 mb-2 rounded-md"><b>${n.fecha_nota}</b><p>${n.resumen_automatico||n.texto_nota}</p></div>`).join("")}</div>`;
  setTimeout(()=>{renderGraficoLabs(labData);renderGraficoExtra(labData);},150);
}

/* -------------------- LABORATORIOS -------------------- */
async function cargarLaboratorios(){
  const {data}=await supabase.from("laboratorios").select("*, pacientes(edad,sexo)").limit(500);
  const cont=document.getElementById("contenedor");
  const avgHb=avg(data.map(d=>d.HbA1c)), avgTFG=avg(data.map(d=>d.TFG));
  cont.innerHTML=`
  <div class="grid grid-cols-2 gap-6 mb-4 text-center">
    <div class="panel"><h3 class="text-[var(--verde)] font-semibold">HbA1c media</h3><p class="text-2xl font-bold">${avgHb.toFixed(2)}%</p></div>
    <div class="panel"><h3 class="text-[var(--verde)] font-semibold">TFG media</h3><p class="text-2xl font-bold">${avgTFG.toFixed(2)}</p></div>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="panel"><canvas id="labHbEdad"></canvas></div>
    <div class="panel"><canvas id="labTFGSexo"></canvas></div>
    <div class="panel"><canvas id="labRiesgo"></canvas></div>
    <div class="panel"><canvas id="labCreatTFG"></canvas></div>
  </div>`;
  const porEdad=groupByRange(data,"pacientes.edad",10);
  charts.push(new Chart("labHbEdad",{type:"line",data:{labels:porEdad.map(g=>g.range),datasets:[{label:"HbA1c media",data:porEdad.map(g=>avg(g.map(x=>x.HbA1c))),borderColor:"#e76f51"}]},options:{plugins:{title:{display:true,text:"HbA1c promedio por edad"}}}}));
  const sexos=["Hombre","Mujer"],tfgSex=sexos.map(s=>avg(data.filter(d=>d.pacientes?.sexo===s).map(x=>x.TFG)));
  charts.push(new Chart("labTFGSexo",{type:"bar",data:{labels:sexos,datasets:[{label:"TFG media",data:tfgSex,backgroundColor:"#4aba84"}]},options:{plugins:{title:{display:true,text:"TFG por sexo"}}}}));
  const riesgos=countBy(data.map(x=>x.flag_riesgo||"Desconocido"));
  charts.push(new Chart("labRiesgo",{type:"doughnut",data:{labels:Object.keys(riesgos),datasets:[{data:Object.values(riesgos),backgroundColor:["#dcfce7","#fef9c3","#fee2e2","#e5e7eb"]}]},options:{plugins:{title:{display:true,text:"Distribución riesgo"}}}}));
  charts.push(new Chart("labCreatTFG",{type:"scatter",data:{datasets:[{label:"Creatinina vs TFG",data:data.map(d=>({x:d.creatinina,y:d.TFG})),backgroundColor:"#2b7a58"}]},options:{plugins:{title:{display:true,text:"Creatinina vs TFG"}}}}));
}

/* -------------------- MEDICACIONES -------------------- */
async function cargarMedicaciones(){
  const {data}=await supabase.from("medicaciones").select("*").limit(500);
  const cont=document.getElementById("contenedor");
  cont.innerHTML=`
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="panel"><canvas id="medFrecuencia"></canvas></div>
    <div class="panel"><canvas id="medAdherencia"></canvas></div>
  </div>
  <div class="panel">
    <h3 class="font-semibold text-[var(--verde)] mb-3">Listado de Medicaciones</h3>
    <table class="w-full text-sm">
      <thead><tr class="border-b"><th class="text-left py-1">Principio Activo</th><th>Pacientes</th><th>Descargar</th></tr></thead>
      <tbody id="tablaMeds"></tbody>
    </table>
  </div>`;
  const count=countBy(data.map(m=>m.principio_activo));
  const medsOrd=Object.entries(count).sort((a,b)=>b[1]-a[1]);
  charts.push(new Chart("medFrecuencia",{type:"bar",data:{labels:medsOrd.map(m=>m[0]),datasets:[{label:"Pacientes tratados",data:medsOrd.map(m=>m[1]),backgroundColor:"#4aba84"}]},options:{indexAxis:"y",plugins:{title:{display:true,text:"Principios activos más frecuentes"}}}}));
  const adMed=Object.entries(groupBy(data,"principio_activo")).map(([k,v])=>({k,avg:avg(v.map(x=>x.adherencia))})).sort((a,b)=>b.avg-a.avg);
  charts.push(new Chart("medAdherencia",{type:"bar",data:{labels:adMed.map(x=>x.k),datasets:[{label:"Adherencia media (%)",data:adMed.map(x=>x.avg),backgroundColor:"#f4a261"}]},options:{indexAxis:"y",plugins:{title:{display:true,text:"Adherencia media por fármaco"}}}}));
  const tbody=document.getElementById("tablaMeds");
  tbody.innerHTML=medsOrd.map(([k,v])=>`<tr class="border-b hover:bg-gray-50"><td class="py-1">${k}</td><td class="text-center">${v}</td><td class="text-center"><button class="btn" onclick="descargarPacientes('${k}')">Ver/Descargar</button></td></tr>`).join("");
}

async function descargarPacientes(farmaco){
  const {data:meds}=await supabase.from("medicaciones").select("patient_id").eq("principio_activo",farmaco);
  const ids=meds.map(m=>m.patient_id);
  const {data:pacientes}=await supabase.from("pacientes").select("*").in("patient_id",ids);
  const csv=[Object.keys(pacientes[0]||{}).join(",")].concat(pacientes.map(p=>Object.values(p).map(v=>`"${v}"`).join(","))).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;a.download=`Pacientes_${farmaco}.csv`;a.click();URL.revokeObjectURL(url);
}

/* -------------------- UTILIDADES -------------------- */
function avg(a){return a.filter(x=>x!=null&&!isNaN(x)).reduce((s,v)=>s+v,0)/(a.filter(x=>x!=null&&!isNaN(x)).length||1);}
function countBy(a){return a.reduce((o,v)=>(o[v]=(o[v]||0)+1,o),{});}
function groupBy(a,p){return a.reduce((o,v)=>{const k=v[p]||"Desconocido";(o[k]=o[k]||[]).push(v);return o;},{});}
function groupByRange(a,p,s){const o=[];a.forEach(v=>{const val=parseInt(v[p])||0;const b=Math.floor(val/s)*s;const r=`${b}-${b+s-1}`;(o.find(x=>x.range===r)?.push(v))||(o.push(Object.assign([v],{range:r})))});return o;}
function renderGraficoLabs(data){const c=new Chart("graficoLabs",{type:"line",data:{labels:data.map(l=>l.fecha_prueba),datasets:[{label:"HbA1c",data:data.map(l=>l.HbA1c),borderColor:"#e76f51"},{label:"TFG",data:data.map(l=>l.TFG),borderColor:"#2a9d8f",yAxisID:"y1"}]},options:{scales:{y1:{position:"right"}},plugins:{title:{display:true,text:"Evolución HbA1c y TFG"}}}});charts.push(c);}
function renderGraficoExtra(data){const c=new Chart("graficoExtra",{type:"bar",data:{labels:data.map(l=>l.fecha_prueba),datasets:[{label:"Colesterol total",data:data.map(l=>l.colesterol_total),backgroundColor:"#4aba84"},{label:"Triglicéridos",data:data.map(l=>l.triglicéridos),backgroundColor:"#f4a261"}]},options:{plugins:{title:{display:true,text:"Perfil lipídico"}}}});charts.push(c);}
cambiarVista("pacientes");
</script>
</body>
</html>
