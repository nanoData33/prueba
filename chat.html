<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CohortIQ – Visualizador Clínico</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --fondo: #f5f7f5;
  --card: #ffffff;
  --verde: #2f6e3e;
  --verde-oscuro: #245831;
  --gris: #3b3b3b;
  --sombra: rgba(0,0,0,0.1);
}
body {
  font-family: "Poppins", sans-serif;
  background: var(--fondo);
  color: var(--gris);
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background: var(--card);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 40px;
  box-shadow: 0 2px 8px var(--sombra);
}
header h1 {
  font-size: 1.2rem;
  color: var(--verde);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
header button {
  background: var(--verde);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-weight: 500;
  cursor: pointer;
}
header button:hover { background: var(--verde-oscuro); }

main {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  padding: 20px;
}

.chat-box, .tabla-box {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 10px var(--sombra);
  padding: 20px;
  display: flex;
  flex-direction: column;
}

h2 {
  text-align: center;
  color: var(--verde);
  margin-bottom: 10px;
  font-weight: 600;
}

.messages {
  flex: 1;
  overflow-y: auto;
  background: #f8faf8;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}

.msg {
  margin-bottom: 12px;
  padding: 12px 15px;
  border-radius: 12px;
  line-height: 1.5;
  max-width: 85%;
  word-wrap: break-word;
}
.msg.user {
  background: var(--verde);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 0;
}
.msg.bot {
  background: #e8f3e8;
  color: var(--gris);
  align-self: flex-start;
  border-bottom-left-radius: 0;
}

.typing {
  display: flex;
  gap: 5px;
  margin-top: 5px;
  padding-left: 5px;
}
.dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--verde);
  animation: blink 1.2s infinite;
}
.dot:nth-child(2){ animation-delay: 0.2s; }
.dot:nth-child(3){ animation-delay: 0.4s; }
@keyframes blink {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

.input-area {
  display: flex;
  gap: 10px;
}
input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
}
button.action {
  background: var(--verde);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  cursor: pointer;
}
button.action:hover { background: var(--verde-oscuro); }

.recomendacion {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #e0e0e0;
}
.recomendacion p { font-weight: 500; margin-bottom: 8px; }
.recomendacion button {
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  margin-right: 6px;
  cursor: pointer;
  transition: 0.2s;
  font-weight: 500;
}
.btn-rec {
  background: var(--verde);
  color: white;
}
.btn-alt {
  background: #e5e7eb;
  color: var(--gris);
}
.btn-rec:hover { background: var(--verde-oscuro); }
.btn-alt:hover { background: #d1d5db; }

canvas { width: 100% !important; height: 400px !important; }

footer {
  background: var(--card);
  text-align: center;
  padding: 8px;
  font-size: 0.85rem;
  color: #555;
  box-shadow: 0 -2px 6px var(--sombra);
}
</style>
</head>

<body>
<header>
  <h1><i data-lucide="stethoscope"></i> CohortIQ – Asistente Clínico</h1>
  <button onclick="window.location.href='index.html'">Volver al Inicio</button>
</header>

<main>
  <div class="chat-box">
    <h2>Chat con el Agente</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu mensaje..." onkeydown="if(event.key==='Enter') sendText()" />
      <button class="action" onclick="sendText()">Enviar</button>
    </div>
  </div>

  <div class="tabla-box">
    <h2>Resultados</h2>
    <canvas id="chart"></canvas>
  </div>
</main>

<footer>© 2025 CohortIQ – Plataforma Inteligente de Apoyo Clínico</footer>

<script>
lucide.createIcons();

const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const supabaseUrl = "https://TU_URL_SUPABASE.supabase.co";
const supabaseKey = "TU_API_KEY";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let chartInstance = null;

function appendMessage(sender, text) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerText = text;
  document.getElementById("messages").appendChild(msg);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

function showTyping() {
  const div = document.createElement("div");
  div.id = "typing";
  div.className = "typing";
  div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  document.getElementById("messages").appendChild(div);
}
function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

async function sendText() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";
  showTyping();

  try {
    const res = await fetch(webhook, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({type:"text", content:text})
    });
    const data = await res.json();
    removeTyping();
    if (data.respuesta) appendMessage("bot", data.respuesta);

    // Si llega un objeto con SQL y campos del gráfico
    if (data.sql && data.x && data.y) {
      const cleanType = data.chart_type?.replace(/[()]/g,"") || "bar";
      renderChartFromSQL(data.sql, cleanType, data.x, data.y);
    }
  } catch {
    removeTyping();
    appendMessage("bot","Error al conectar con el agente.");
  }
}

async function renderChartFromSQL(sql, chartType, xField, yField) {
  try {
    const { data, error } = await supabase.rpc("execute_sql_query", { query: sql });
    if (error) throw error;

    const labels = data.map(row => row[xField]);
    const values = data.map(row => row[yField]);

    const ctx = document.getElementById("chart").getContext("2d");
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: chartType,
      data: {
        labels,
        datasets: [{
          label: `${yField} vs ${xField}`,
          data: values,
          backgroundColor: "rgba(47,110,62,0.6)",
          borderColor: "rgba(47,110,62,1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch (err) {
    console.error(err);
    appendMessage("bot","Error al generar el gráfico.");
  }
}
</script>
</body>
</html>
