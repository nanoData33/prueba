<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Clínico – Chat Inteligente</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root {
    --fondo: #f4f7f5;
    --card: #ffffff;
    --acento: #3b7b46;
    --acento-hover: #2f6137;
    --gris-texto: #1f1f1f;
    --sombra: rgba(0,0,0,0.08);
  }
  body {
    font-family: 'Poppins', sans-serif;
    background: var(--fondo);
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--card);
    color: var(--gris-texto);
    padding: 16px 32px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px var(--sombra);
  }
  header h1 { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; }
  header button {
    background: var(--acento);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 500;
  }
  header button:hover { background: var(--acento-hover); }
  main { flex: 1; display: flex; padding: 20px; gap: 20px; }

  .chat-box, .tabla-box {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 4px 12px var(--sombra);
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  .chat-box { flex: 1; }
  .tabla-box { flex: 1; overflow-y: auto; }

  h2 { color: var(--acento); text-align: center; margin-bottom: 12px; }

  .messages {
    flex: 1; overflow-y: auto; background: #f8faf8;
    border-radius: 10px; padding: 12px; margin-bottom: 10px;
  }
  .msg { margin-bottom: 10px; padding: 10px 14px; border-radius: 12px; max-width: 85%; }
  .msg.user {
    background: var(--acento); color: white; align-self: flex-end;
    border-top-right-radius: 0;
  }
  .msg.bot {
    background: #e9f3ea; color: var(--gris-texto); align-self: flex-start;
    border-top-left-radius: 0;
  }

  .input-area {
    display: flex; gap: 10px; margin-top: 10px;
  }
  input {
    flex: 1; padding: 10px 14px; border: 1px solid #ccc;
    border-radius: 8px; font-size: 0.95rem;
  }
  button.action {
    background: var(--acento); color: white; border: none;
    border-radius: 8px; padding: 10px 14px; cursor: pointer;
  }
  button.action:hover { background: var(--acento-hover); }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: var(--acento); color: white; }
  tr:nth-child(even) { background: #f7f9f7; }

  .loading-dots { display: flex; gap: 5px; padding: 8px; }
  .dot {
    width: 8px; height: 8px; background: var(--acento);
    border-radius: 50%; animation: bounce 1.2s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  footer { text-align: center; padding: 8px; font-size: 0.85em; color: #666; background: var(--card); }
</style>
</head>

<body>
<header>
  <h1><i data-lucide="stethoscope"></i> Asistente Clínico Inteligente</h1>
  <button onclick="window.location.href='index.html'">Volver al inicio</button>
</header>

<main>
  <div class="chat-box">
    <h2>Chat con el Agente</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu mensaje..." onkeydown="if(event.key==='Enter') sendText()" />
      <button class="action" onclick="sendText()">Enviar</button>
    </div>
  </div>

  <div class="tabla-box">
    <h2>Resultados</h2>
    <div id="tablaContainer">Esperando resultados...</div>
  </div>
</main>

<footer>© 2025 Asistente Clínico – Análisis Conversacional</footer>

<script>
lucide.createIcons();

const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const messagesDiv = document.getElementById("messages");
const tablaDiv = document.getElementById("tablaContainer");
const input = document.getElementById("userInput");

function appendMessage(sender, html) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerHTML = html;
  messagesDiv.appendChild(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showLoadingDots() {
  const container = document.createElement("div");
  container.className = "msg bot";
  container.id = "loading";
  container.innerHTML = `<div class='loading-dots'><div class='dot'></div><div class='dot'></div><div class='dot'></div></div>`;
  messagesDiv.appendChild(container);
}
function removeLoading() {
  const loading = document.getElementById("loading");
  if (loading) loading.remove();
}

async function sendText() {
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";
  showLoadingDots();

  try {
    const res = await fetch(webhook, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "text", content: text })
    });
    const data = await res.json();
    removeLoading();

    appendMessage("bot", `<b>Consulta interpretada:</b> ${data.consulta || "No disponible"}`);
    appendMessage("bot", `<b>Recomendación de gráfico:</b> ${data.recomendacion?.replace(/[()]/g,"") || "—"}`);

    // Si la respuesta parece tabla (tiene separadores o formato JSON)
    if (typeof data.respuesta === "string" && (data.respuesta.includes("|") || data.respuesta.includes("{"))) {
      tablaDiv.innerHTML = `<pre style="background:#f8faf8;padding:10px;border-radius:8px;overflow:auto;">${data.respuesta}</pre>`;
    }

    // Ejecutar SQL y graficar siempre
    if (data.sql && data.x && data.y) {
      const sql = data.sql;
      const chartType = (data.chart_type || "").replace(/[()]/g,"").trim();

      const { data: result, error } = await supabase.rpc("execute_sql_query", { query: sql });
      if (error || !result || !result[0].result) {
        tablaDiv.innerHTML = "<p style='color:#b91c1c'>Error al ejecutar la consulta en Supabase.</p>";
        return;
      }
      const rows = result[0].result;
      renderChart(rows, data.x, data.y, chartType || "bar");
    }

  } catch (err) {
    removeLoading();
    appendMessage("bot", "Error al conectar con el agente o ejecutar la consulta.");
  }
}

function renderChart(rows, xCol, yCol, chartType) {
  tablaDiv.innerHTML = "<canvas id='chartCanvas'></canvas>";
  const ctx = document.getElementById("chartCanvas");
  const labels = rows.map(r => r[xCol]);
  const values = rows.map(r => r[yCol]);
  new Chart(ctx, {
    type: chartType,
    data: {
      labels: labels,
      datasets: [{
        label: `${yCol} por ${xCol}`,
        data: values,
        backgroundColor: "#3b7b46",
        borderColor: "#2f5f33",
        borderWidth: 1
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } }
  });
}
</script>
</body>
</html>
