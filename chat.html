<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Clínico – Chat Inteligente</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --fondo: #f3f5f1;
    --card: #ffffff;
    --acento: #3b7b46;
    --acento-hover: #2f6137;
    --gris-texto: #1f1f1f;
    --sombra: rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Poppins', sans-serif;
    background: var(--fondo);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--card);
    color: var(--gris-texto);
    padding: 18px 40px;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 2px 8px var(--sombra);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 { font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
  header button {
    background: var(--acento);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.25s ease;
  }
  header button:hover { background: var(--acento-hover); }

  main { flex: 1; display: flex; padding: 20px; gap: 20px; }

  .chat-box, .tabla-box {
    flex: 1;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 4px 12px var(--sombra);
    padding: 25px;
    display: flex;
    flex-direction: column;
  }

  h2 { color: var(--acento); margin-bottom: 10px; text-align: center; font-weight: 600; }

  .messages {
    flex: 1;
    overflow-y: auto;
    background: #f8f9f7;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
  }

  .msg { margin-bottom: 12px; padding: 12px 16px; border-radius: 12px; line-height: 1.5; max-width: 80%; word-wrap: break-word; }
  .msg.user { background: var(--acento); color: white; align-self: flex-end; border-top-right-radius: 0; }
  .msg.bot { background: #e6f2e6; color: var(--gris-texto); align-self: flex-start; border-top-left-radius: 0; }

  .input-area { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  input { flex: 1; padding: 12px 14px; border: 1px solid #ccc; border-radius: 10px; outline: none; font-size: 0.95rem; }
  button.action { background: var(--acento); color: white; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: background 0.25s; }
  button.action:hover { background: var(--acento-hover); }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9rem; }
  th { background: var(--acento); color: white; }
  tr:nth-child(even) { background-color: #f9f9f9; }

  .recomendacion { margin-top: 15px; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; background: #f3f4f6; }
  .recomendacion button { margin: 6px; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
  .btn-rec { background: var(--acento); color: white; }
  .btn-alt { background: #e5e7eb; color: var(--gris-texto); }

  footer { text-align: center; padding: 10px; background: var(--card); font-size: 0.9em; color: #666; box-shadow: 0 -2px 8px var(--sombra); }
</style>
</head>

<body>
<header>
  <h1><i data-lucide="stethoscope"></i> Asistente Clínico Inteligente</h1>
  <button onclick="window.open('analitica.html', '_blank')">Analizar Analítica</button>
</header>

<main>
  <div class="chat-box">
    <h2>Chat con el Agente</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu mensaje..." onkeydown="if(event.key==='Enter') sendText()" />
      <button class="action" onclick="sendText()">Enviar</button>
    </div>
  </div>

  <div class="tabla-box">
    <h2>Resultados</h2>
    <div id="tablaContainer"></div>
  </div>
</main>

<footer>© 2025 Asistente Clínico – Módulo de Análisis Conversacional</footer>

<script>
lucide.createIcons();

const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const webhookGrafico = "https://rubaseval.app.n8n.cloud/webhook-test/grafico";

let ultimaConsulta = "";
let ultimaSQL = "";

function appendMessage(sender, html) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerHTML = html;
  document.getElementById("messages").appendChild(msg);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

async function sendText() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  appendMessage("user", text);
  ultimaConsulta = text;
  input.value = "";

  try {
    const res = await fetch(webhook, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "text", content: text })
    });
    const data = await res.json();
    console.log("Respuesta de n8n:", data);

    if (data.sql) ultimaSQL = data.sql;

    if (data.respuesta) {
      try {
        const parsed = JSON.parse(data.respuesta);
        if (Array.isArray(parsed)) renderTable(parsed);
        else appendMessage("bot", `<pre>${JSON.stringify(parsed, null, 2)}</pre>`);
      } catch {
        appendMessage("bot", data.respuesta);
      }
    }

    if (data.recomendacion) renderRecomendaciones(data.recomendacion);

  } catch (err) {
    appendMessage("bot", "⚠️ Error al conectar con el agente.");
  }
}

function renderTable(arrayData) {
  const cont = document.getElementById("tablaContainer");
  if (!arrayData.length) return (cont.innerHTML = "<p>Sin resultados.</p>");
  const cols = Object.keys(arrayData[0]);
  let html = "<table><thead><tr>" + cols.map(c=>`<th>${c}</th>`).join("") + "</tr></thead><tbody>";
  arrayData.forEach(row => {
    html += "<tr>" + cols.map(c=>`<td>${row[c]}</td>`).join("") + "</tr>";
  });
  html += "</tbody></table>";
  cont.innerHTML = html;
}

function renderRecomendaciones(tipo) {
  const div = document.createElement("div");
  div.className = "recomendacion";
  div.innerHTML = `<p><strong>Recomendación del agente:</strong> gráfico ${tipo}</p>`;
  const tipos = ["bar", "line", "scatter", "pie", "histogram"];
  tipos.forEach(t => {
    const b = document.createElement("button");
    b.textContent = (t === tipo ? "Enviar decisión: Recomendado (" + t + ")" : "Enviar " + t);
    b.className = (t === tipo ? "btn-rec" : "btn-alt");
    b.onclick = () => enviarDecision(t, t === tipo ? "recomendado" : "alternativo");
    div.appendChild(b);
  });
  document.getElementById("messages").appendChild(div);
}

async function enviarDecision(tipo, decision) {
  appendMessage("bot", `✅ Decisión registrada: ${decision} (${tipo})`);
  try {
    await fetch(webhookGrafico, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        sql: ultimaSQL,
        consulta: ultimaConsulta,
        decision: decision + " (" + tipo + ")"
      })
    });
  } catch (err) {
    appendMessage("bot", "⚠️ Error al enviar la decisión a n8n.");
  }
}
</script>
</body>
</html>
