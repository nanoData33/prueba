<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ – Visualizador Clínico</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --verde:#2f6e3e;--verde-oscuro:#245831;--gris:#3b3b3b;--fondo:#f5f7f5;--card:#fff;--sombra:rgba(0,0,0,0.1);
}
body{font-family:"Poppins",sans-serif;margin:0;background:var(--fondo);color:var(--gris);}
header{background:var(--card);display:flex;justify-content:space-between;align-items:center;padding:15px 40px;box-shadow:0 2px 8px var(--sombra);}
header h1{color:var(--verde);display:flex;align-items:center;gap:8px;}
header button{background:var(--verde);color:white;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;}
header button:hover{background:var(--verde-oscuro);}
main{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px;}
.chat-box,.tabla-box{background:var(--card);border-radius:12px;box-shadow:0 4px 10px var(--sombra);padding:20px;display:flex;flex-direction:column;}
h2{text-align:center;color:var(--verde);}
.messages{flex:1;overflow-y:auto;background:#f8faf8;border-radius:10px;padding:15px;margin-bottom:10px;}
.msg{margin-bottom:12px;padding:12px 15px;border-radius:12px;max-width:85%;}
.msg.user{background:var(--verde);color:white;align-self:flex-end;}
.msg.bot{background:#e8f3e8;align-self:flex-start;}
.input-area{display:flex;gap:10px;}
input{flex:1;padding:10px;border:1px solid #ccc;border-radius:10px;}
button.action{background:var(--verde);color:white;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;}
button.action:hover{background:var(--verde-oscuro);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;text-align:left;}
th{background:var(--verde);color:white;}
tr:nth-child(even){background:#f5f7f5;}
.btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.btn-chart{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
.btn-rec{background:var(--verde);color:white;}
.btn-alt{background:#e6e8e6;}
.btn-alt:hover{background:#d3d5d3;}
#verDatasetBtn{margin-top:12px;background:var(--verde);color:white;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;width:100%;}
#verDatasetBtn:hover{background:var(--verde-oscuro);}
canvas{width:100%!important;height:380px!important;}
footer{text-align:center;background:var(--card);padding:8px;color:#555;font-size:0.85rem;}
</style>
</head>

<body>
<header>
  <h1><i data-lucide="stethoscope"></i> CohortIQ – Asistente Clínico</h1>
  <button onclick="window.location.href='index.html'">Volver al Inicio</button>
</header>

<main>
  <div class="chat-box">
    <h2>Chat con el Agente</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu mensaje...">
      <button class="action" id="sendBtn">Enviar</button>
    </div>
  </div>

  <div class="tabla-box">
    <h2>Resultados</h2>
    <div id="tablaContainer">Esperando resultados...</div>
    <canvas id="chartCanvas"></canvas>
  </div>
</main>

<footer>© 2025 CohortIQ – Plataforma Inteligente de Apoyo Clínico</footer>

<script>
lucide.createIcons();

const webhook="https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const webhookGrafico="https://rubaseval.app.n8n.cloud/webhook-test/grafico";
const webhookDataset="https://rubaseval.app.n8n.cloud/webhook-test/dataset";
let ultimaConsultaSQL="";
let chartInstance=null;

document.getElementById("sendBtn").addEventListener("click",sendText);
document.getElementById("userInput").addEventListener("keydown",e=>{if(e.key==="Enter")sendText();});

function appendMessage(sender,text,html=false){
  const msg=document.createElement("div");
  msg.className="msg "+sender;
  msg.innerHTML=html?text:text.replace(/\n/g,"<br>");
  document.getElementById("messages").appendChild(msg);
}

async function sendText(){
  const input=document.getElementById("userInput");
  const text=input.value.trim();
  if(!text)return;
  appendMessage("user",text);
  input.value="";
  appendMessage("bot","Procesando...");
  try{
    const res=await fetch(webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"text",content:text})});
    const data=await res.json();
    document.querySelector(".msg.bot:last-child").remove();
    if(data.respuesta && data.respuesta.includes("|")){
      renderMarkdownTable(data.respuesta);
      ultimaConsultaSQL=data.sql||"";
      renderChartButtonsInChat(data.sql,data.recomendacion,data.x,data.y,data.consulta);
    }else appendMessage("bot",data.respuesta||"Sin respuesta del agente.");
  }catch(e){appendMessage("bot","Error de conexión con el agente.");}
}

function renderMarkdownTable(text){
  const lines=text.trim().split("\n").filter(l=>l.includes("|"));
  const headers=lines[0].split("|").map(h=>h.trim()).filter(Boolean);
  const rows=lines.slice(2).map(l=>l.split("|").map(c=>c.trim()).filter(Boolean));
  let html="<table><thead><tr>";
  headers.forEach(h=>html+=`<th>${h}</th>`);
  html+="</tr></thead><tbody>";
  rows.forEach(r=>html+="<tr>"+r.map(c=>`<td>${c}</td>`).join("")+"</tr>");
  html+="</tbody></table>";
  html+=`<button id="verDatasetBtn">Ver resultado completo</button>`;
  document.getElementById("tablaContainer").innerHTML=html;
  document.getElementById("verDatasetBtn").addEventListener("click",enviarDataset);
}

function renderChartButtonsInChat(sql,recType,x,y,consulta){
  const tipos=["bar","line","scatter","pie","histogram"];
  const cleanType=(recType||"bar").replace(/[()]/g,"").trim();
  let html=`<p><strong>El agente sugiere:</strong> gráfico <strong>${cleanType}</strong>. Otros tipos:</p><div class="btn-group">`;
  tipos.forEach(t=>{
    const clase=t===cleanType?"btn-rec":"btn-alt";
    html+=`<button class="btn-chart ${clase}" data-tipo="${t}" data-sql='${sql}' data-x='${x}' data-y='${y}' data-consulta='${consulta}'>${t}</button>`;
  });
  html+="</div>";
  appendMessage("bot",html,true);

  // ahora activamos los botones
  document.querySelectorAll(".btn-chart").forEach(btn=>{
    btn.addEventListener("click",()=>manejarGrafico(btn));
  });
}

async function manejarGrafico(btn){
  const tipo=btn.dataset.tipo;
  const payload={sql:btn.dataset.sql,chart_type:tipo,x:btn.dataset.x,y:btn.dataset.y};
  appendMessage("bot",`Enviando gráfico ${tipo} a n8n...`);
  try{
    const res=await fetch(webhookGrafico,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(res.ok){
      appendMessage("bot",`Confirmado: gráfico ${tipo} enviado correctamente.`);
      // usar el mismo payload para renderizar gráfico local
      renderLocalChart(payload);
    }else{
      appendMessage("bot","Error al enviar gráfico a n8n.");
    }
  }catch{
    appendMessage("bot","Error de conexión con n8n.");
  }
}

function renderLocalChart({chart_type,x,y}){
  const ctx=document.getElementById("chartCanvas").getContext("2d");
  if(chartInstance) chartInstance.destroy();

  // datos simulados (hasta que lleguen reales desde supabase/n8n)
  const labels=["A","B","C","D","E"];
  const values=labels.map(()=>Math.floor(Math.random()*20)+5);

  let type=chart_type;
  if(chart_type==="histogram") type="bar";

  chartInstance=new Chart(ctx,{
    type:type,
    data:{
      labels:labels,
      datasets:[{
        label:`${y} vs ${x}`,
        data:values,
        backgroundColor:"rgba(47,110,62,0.6)",
        borderColor:"rgba(47,110,62,1)",
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{y:{beginAtZero:true}}
    }
  });
}

async function enviarDataset(){
  if(!ultimaConsultaSQL){appendMessage("bot","No hay SQL para enviar.");return;}
  appendMessage("bot","Solicitando dataset completo...");
  try{
    const res=await fetch(webhookDataset,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sql:ultimaConsultaSQL})});
    const data=await res.json();
    localStorage.setItem("datasetData",JSON.stringify(data));
    window.open("dataset.html","_blank");
  }catch{appendMessage("bot","Error al conectar con n8n.");}
}
</script>
</body>
</html>
