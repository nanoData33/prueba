<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ ‚Äî Seguimiento de Cohorte</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #2b7a58;
    --verde-claro: #48b07a;
    --gris-fondo: #f7f8f7;
  }

  body { font-family: "Inter", sans-serif; background: var(--gris-fondo); color: #1f2937; }
  header { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .panel { background: white; border-radius: 0.8rem; padding: 1.5rem; box-shadow: 0 1px 6px rgba(0,0,0,0.05); }
  .btn { background: var(--verde); color: white; padding: 0.6rem 1rem; border-radius: 0.4rem; font-weight: 500; transition: 0.2s; }
  .btn:hover { background: var(--verde-claro); }
  .btn-sec { background: #23437e; }
  .btn-sec:hover { background: #345eaa; }
  .btn-alt { background: #d97706; }
  .btn-alt:hover { background: #b45309; }
  .kpi { background:white; border-radius:0.7rem; text-align:center; padding:1rem; box-shadow:0 1px 5px rgba(0,0,0,0.05); }
  #detalle { position:fixed; top:0; right:0; width:360px; height:100vh; background:white; box-shadow:-4px 0 10px rgba(0,0,0,0.1); padding:1.5rem; overflow-y:auto; transform:translateX(100%); transition:transform 0.3s ease; z-index:50; }
  #detalle.activo { transform:translateX(0); }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 id="tituloCohorte" class="text-xl font-semibold text-[var(--verde)]">Cohorte</h1>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">‚Üê Volver al panel</a>
</header>

<main class="p-8 space-y-8">

  <!-- KPIs -->
  <section class="grid grid-cols-2 md:grid-cols-5 gap-4">
    <div class="kpi"><h4 class="text-gray-500 text-sm">Pacientes</h4><p id="kpiPacientes" class="text-2xl font-semibold text-[var(--verde)]">-</p></div>
    <div class="kpi"><h4 class="text-gray-500 text-sm">Edad media</h4><p id="kpiEdad" class="text-2xl font-semibold text-[var(--verde)]">-</p></div>
    <div class="kpi"><h4 class="text-gray-500 text-sm">% Controlados</h4><p id="kpiControlados" class="text-2xl font-semibold text-[var(--verde)]">-</p></div>
    <div class="kpi"><h4 class="text-gray-500 text-sm">% Adherencia</h4><p id="kpiAdherencia" class="text-2xl font-semibold text-[var(--verde)]">-</p></div>
    <div class="kpi"><h4 class="text-gray-500 text-sm">IMC medio</h4><p id="kpiIMC" class="text-2xl font-semibold text-[var(--verde)]">-</p></div>
  </section>

  <!-- Gr√°ficos -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="panel">
      <h3 class="font-semibold text-[var(--verde)] mb-2">Tendencia HbA1c</h3>
      <canvas id="grafHbA1c"></canvas>
    </div>
    <div class="panel">
      <h3 class="font-semibold text-[var(--verde)] mb-2">Tendencia TFG</h3>
      <canvas id="grafTFG"></canvas>
    </div>
    <div class="panel">
      <h3 class="font-semibold text-[var(--verde)] mb-2">Distribuci√≥n IMC</h3>
      <canvas id="grafIMC"></canvas>
    </div>
  </section>

  <!-- Tratamientos -->
  <section class="panel">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold text-[var(--verde)]">Tratamientos m√°s usados</h3>
      <div class="flex gap-2">
        <button class="btn" onclick="accion('informe')">Generar informe</button>
        <button class="btn-alt" onclick="accion('avisar')">Avisar pacientes</button>
        <button class="btn-sec" onclick="accion('exportar')">Exportar datos</button>
      </div>
    </div>
    <canvas id="grafMedicaciones"></canvas>
  </section>

  <!-- Tabla riesgo -->
  <section class="panel">
    <h3 class="font-semibold text-[var(--verde)] mb-2">Pacientes fuera de rango</h3>
    <table class="w-full text-sm border-t">
      <thead><tr><th>Paciente</th><th>HbA1c</th><th>TFG</th><th>Adherencia</th><th>Estado</th></tr></thead>
      <tbody id="tablaRiesgo"></tbody>
    </table>
  </section>
</main>

<!-- Panel lateral detalle -->
<div id="detalle">
  <h2 id="detalleTitulo" class="text-lg font-semibold text-[var(--verde)] mb-2"></h2>
  <div id="detalleContenido" class="text-sm text-gray-700"></div>
</div>

<script>
lucide.createIcons();

const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const params = new URLSearchParams(window.location.search);
const cohorte = decodeURIComponent(params.get("nombre"));
document.getElementById("tituloCohorte").textContent = "Cohorte: " + cohorte;

async function cargarDatos() {
  const { data: pacientes } = await supabase.from("pacientes").select("*").eq("enfermedad_principal", cohorte);
  const ids = pacientes.map(p => p.patient_id);
  const [labs, meds] = await Promise.all([
    supabase.from("laboratorios").select("*").in("patient_id", ids),
    supabase.from("medicaciones").select("*").in("patient_id", ids)
  ]);

  // KPIs
  document.getElementById("kpiPacientes").textContent = pacientes.length;
  document.getElementById("kpiEdad").textContent = promedio(pacientes.map(p=>p.edad)).toFixed(1) + " a√±os";
  document.getElementById("kpiControlados").textContent = ((labs.data.filter(l=>l.HbA1c<7 && l.TFG>60).length/labs.data.length)*100).toFixed(1) + "%";
  document.getElementById("kpiAdherencia").textContent = promedio(meds.data.map(m=>m.adherencia)).toFixed(1) + "%";
  document.getElementById("kpiIMC").textContent = promedio(pacientes.map(p=>p.IMC)).toFixed(1);

  // Gr√°ficos individuales
  graficarLinea("grafHbA1c", labs.data, "HbA1c", "#48b07a");
  graficarLinea("grafTFG", labs.data, "TFG", "#2b7a58");
  graficarHist("grafIMC", pacientes.map(p=>p.IMC));

  const freq={}; meds.data.forEach(m=>{freq[m.principio_activo]=(freq[m.principio_activo]||0)+1});
  const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const ctx = document.getElementById("grafMedicaciones");
  const chart = new Chart(ctx, {
    type:"bar", 
    data:{ labels:top.map(x=>x[0]), datasets:[{ label:"Pacientes", data:top.map(x=>x[1]), backgroundColor:"#48b07a"}]},
    options:{ onClick:(e,els)=>{
      if(els.length){ mostrarDetalle(top[els[0].index][0],"medicacion"); }
    }}
  });

  const riesgo = labs.data.filter(l=>l.HbA1c>8 || l.TFG<50).slice(0,20);
  document.getElementById("tablaRiesgo").innerHTML = riesgo.map(r=>`
    <tr class="border-t hover:bg-gray-50 cursor-pointer" onclick="mostrarDetalle('${r.patient_id}','paciente')">
      <td>${r.patient_id}</td><td>${r.HbA1c}</td><td>${r.TFG}</td>
      <td>${(Math.random()*100).toFixed(1)}%</td>
      <td>${r.HbA1c>9?"Cr√≠tico":r.HbA1c>7?"Moderado":"Estable"}</td></tr>
  `).join("");
}

function promedio(arr){return arr.length?arr.reduce((a,b)=>a+(+b||0),0)/arr.length:0;}

function graficarLinea(id, data, campo, color){
  const fechas = [...new Set(data.map(l=>l.fecha_prueba))].sort();
  const valores = fechas.map(f=>promedio(data.filter(l=>l.fecha_prueba===f).map(l=>l[campo])));
  new Chart(document.getElementById(id), {
    type: "line",
    data: { labels: fechas, datasets: [{ label: campo, data: valores, borderColor: color, tension:0.2, pointRadius:2 }]},
    options: { scales:{y:{beginAtZero:false}}, plugins:{legend:{display:false}} }
  });
}

function graficarHist(id, arr){
  new Chart(document.getElementById(id), {
    type:"bar",
    data:{ labels:["<20","20-25","25-30","30-35",">35"],
      datasets:[{ label:"Pacientes", data:[
        arr.filter(x=>x<20).length, arr.filter(x=>x>=20&&x<25).length,
        arr.filter(x=>x>=25&&x<30).length, arr.filter(x=>x>=30&&x<35).length,
        arr.filter(x=>x>=35).length ], backgroundColor:"#48b07a"}]},
    options:{ plugins:{legend:{display:false}} }
  });
}

function mostrarDetalle(id,tipo){
  const panel = document.getElementById("detalle");
  const titulo = document.getElementById("detalleTitulo");
  const cont = document.getElementById("detalleContenido");
  panel.classList.add("activo");

  if(tipo==="paciente"){
    titulo.textContent = "Paciente " + id;
    cont.innerHTML = `<p>Mostrando informaci√≥n detallada del paciente y su evoluci√≥n.</p>`;
  } else {
    titulo.textContent = "Tratamiento: " + id;
    cont.innerHTML = `<p>Pacientes bajo ${id}, adherencia media, dosis, fechas y respuesta cl√≠nica.</p>`;
  }
}

function accion(tipo){
  /* üîó Placeholder de integraci√≥n ‚Äî aqu√≠ se har√° POST autom√°tico
     al endpoint que se definir√° (n8n, API interna, etc) con:
     { cohorte, tipo_accion, timestamp, resumen_kpis, ... }
  */
  console.log("Acci√≥n enviada:", tipo);
  alert("Acci√≥n registrada: " + tipo);
}

cargarDatos();
</script>
</body>
</html>
