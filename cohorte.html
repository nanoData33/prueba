<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Cohorte</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --verde: #3d7658;
    --gris-fondo: #f9faf9;
  }
  body { font-family: 'Inter', sans-serif; background: var(--gris-fondo); }
  .card {
    background: white;
    border-radius: 0.8rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    padding: 1rem;
  }
  .carousel {
    position: relative;
    overflow: hidden;
    height: 320px;
  }
  .carousel-inner {
    display: flex;
    transition: transform 0.4s ease;
  }
  .carousel-item {
    flex: 0 0 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    border-radius: 9999px;
    padding: 0.3rem 0.6rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: 0.2s;
  }
  .carousel-btn:hover { background: #f1f5f4; }
  #btnPrev { left: 0.5rem; }
  #btnNext { right: 0.5rem; }

  #panelDetalle {
    position: fixed;
    right: -420px;
    top: 0;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    transition: right 0.4s ease;
    overflow-y: auto;
  }
  #panelDetalle.abierto { right: 0; }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4 bg-white border-b shadow-sm">
  <div class="flex items-center gap-2">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Cohorte dinámica</span>
  </div>
  <a href="explorar.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al panel</a>
</header>

<main class="p-6 space-y-6">
  <!-- CABECERA DE COHORTE -->
  <section id="resumen" class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="card text-center">
      <h3 class="text-sm text-gray-500">Pacientes</h3>
      <p id="kpiPacientes" class="text-xl font-semibold text-[var(--verde)]">--</p>
    </div>
    <div class="card text-center">
      <h3 class="text-sm text-gray-500">Edad media</h3>
      <p id="kpiEdad" class="text-xl font-semibold text-[var(--verde)]">--</p>
    </div>
    <div class="card text-center">
      <h3 class="text-sm text-gray-500">% Controlados</h3>
      <p id="kpiControl" class="text-xl font-semibold text-[var(--verde)]">--</p>
    </div>
    <div class="card text-center">
      <h3 class="text-sm text-gray-500">% Adherencia</h3>
      <p id="kpiAdh" class="text-xl font-semibold text-[var(--verde)]">--</p>
    </div>
  </section>

  <!-- CARRUSEL DE GRÁFICOS -->
  <section class="card relative">
    <h2 class="text-[var(--verde)] font-semibold mb-2">Indicadores de la cohorte</h2>
    <div class="carousel">
      <div id="carouselInner" class="carousel-inner">
        <div class="carousel-item"><canvas id="grafHbA1c"></canvas></div>
        <div class="carousel-item"><canvas id="grafTFG"></canvas></div>
        <div class="carousel-item"><canvas id="grafIMC"></canvas></div>
        <div class="carousel-item"><canvas id="grafTratamientos"></canvas></div>
        <div class="carousel-item"><canvas id="grafFueraRango"></canvas></div>
        <div class="carousel-item"><canvas id="grafPersonalizado"></canvas></div>
      </div>
      <div id="btnPrev" class="carousel-btn">◀</div>
      <div id="btnNext" class="carousel-btn">▶</div>
    </div>
  </section>

  <!-- CAMPO DE CONSULTA EN LENGUAJE NATURAL -->
  <section class="card">
    <h3 class="font-semibold text-[var(--verde)] mb-2">Crear gráfico personalizado</h3>
    <div class="flex gap-2">
      <input id="consultaTexto" placeholder="Ej: evolución del colesterol medio en 2025"
        class="flex-1 p-2 border rounded-md">
      <button onclick="enviarConsulta()"
        class="bg-[var(--verde)] text-white px-4 rounded-md hover:bg-green-700">Generar</button>
    </div>
    <p id="statusConsulta" class="text-xs text-gray-500 mt-2"></p>
  </section>
</main>

<!-- PANEL DETALLE -->
<aside id="panelDetalle">
  <div class="flex justify-between items-center mb-4">
    <h2 id="tituloDetalle" class="font-semibold text-[var(--verde)]"></h2>
    <button onclick="cerrarDetalle()" class="text-gray-400 hover:text-gray-600">✕</button>
  </div>
  <div id="contenidoDetalle" class="text-sm text-gray-700 space-y-2"></div>
</aside>

<script>
lucide.createIcons();

// Conexión Supabase
const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Carrusel
let currentSlide = 0;
function showSlide(index) {
  const total = document.querySelectorAll(".carousel-item").length;
  if (index < 0) index = total - 1;
  if (index >= total) index = 0;
  currentSlide = index;
  document.getElementById("carouselInner").style.transform = `translateX(-${index * 100}%)`;
}
document.getElementById("btnPrev").onclick = () => showSlide(currentSlide - 1);
document.getElementById("btnNext").onclick = () => showSlide(currentSlide + 1);

// Placeholder de datos iniciales
async function cargarDatos() {
  const { data: pacientes } = await supabase.from("pacientes").select("*");
  document.getElementById("kpiPacientes").textContent = pacientes.length;
  document.getElementById("kpiEdad").textContent = `${(pacientes.reduce((a,b)=>a+b.edad,0)/pacientes.length).toFixed(1)} años`;
  document.getElementById("kpiControl").textContent = `${(Math.random()*40+50).toFixed(1)}%`;
  document.getElementById("kpiAdh").textContent = `${(Math.random()*20+70).toFixed(1)}%`;
  generarGraficos(pacientes);
}

function generarGraficos(pacientes) {
  const ctx1 = new Chart(document.getElementById("grafHbA1c"), {
    type: "line",
    data: { labels: pacientes.map((_,i)=>i), datasets: [{ label:"HbA1c", data: pacientes.map(p=>p.IMC/3), borderColor:"#3d7658" }] },
    options: { plugins:{legend:{display:false}}, scales:{y:{title:{text:"HbA1c",display:true}}} }
  });

  const ctx2 = new Chart(document.getElementById("grafTFG"), {
    type: "line",
    data: { labels: pacientes.map((_,i)=>i), datasets: [{ label:"TFG", data: pacientes.map(p=>100-Math.random()*30), borderColor:"#4ba67d" }] },
    options: { plugins:{legend:{display:false}}, scales:{y:{title:{text:"TFG",display:true}}} }
  });

  const ctx3 = new Chart(document.getElementById("grafIMC"), {
    type: "bar",
    data: {
      labels:["<20","20–25","25–30",">30"],
      datasets:[{ label:"Pacientes", data:[5,30,40,25], backgroundColor:"#3d7658" }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  const ctx4 = new Chart(document.getElementById("grafTratamientos"), {
    type: "bar",
    data: {
      labels:["Furosemida","Calcitriol","Simvastatina","Enalapril","Metformina"],
      datasets:[{ label:"Pacientes", data:[62,54,33,28,15], backgroundColor:"#4ba67d" }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{font:{size:10}}}} }
  });

  const ctx5 = new Chart(document.getElementById("grafFueraRango"), {
    type:"scatter",
    data:{datasets:[{label:"Fuera de rango",data:pacientes.slice(0,30).map(p=>({x:p.edad,y:p.IMC})),backgroundColor:"#e89f3d"}]},
    options:{plugins:{legend:{display:false}},scales:{x:{title:{text:"Edad",display:true}},y:{title:{text:"IMC",display:true}}}}
  });
}

async function enviarConsulta() {
  const texto = document.getElementById("consultaTexto").value.trim();
  if (!texto) return;
  document.getElementById("statusConsulta").textContent = "Analizando consulta...";
  // Aquí se deja preparado el POST al webhook n8n
  setTimeout(() => {
    document.getElementById("statusConsulta").textContent = "Gráfico personalizado generado (placeholder).";
    const ctx = document.getElementById("grafPersonalizado").getContext("2d");
    new Chart(ctx,{type:"line",data:{labels:["Ene","Feb","Mar","Abr"],datasets:[{label:texto,data:[5,6,7,6],borderColor:"#3d7658"}]},options:{plugins:{legend:{display:false}}}});
    showSlide(5);
  },1500);
}

// Panel lateral
function abrirDetalle(titulo, contenido) {
  document.getElementById("tituloDetalle").textContent = titulo;
  document.getElementById("contenidoDetalle").innerHTML = contenido;
  document.getElementById("panelDetalle").classList.add("abierto");
}
function cerrarDetalle() {
  document.getElementById("panelDetalle").classList.remove("abierto");
}

cargarDatos();
</script>
</body>
</html>
