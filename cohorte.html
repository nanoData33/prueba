<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Panel Clínico</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root {
  --verde: #3d7658;
  --verde-claro: #4ba67d;
  --gris-fondo: #f8f9f8;
}
body { background-color: var(--gris-fondo); font-family: 'Inter', sans-serif; }
.card {
  background: white; border-radius: 0.8rem; box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  padding: 1.25rem 1.5rem;
}
th, td { padding: 0.4rem 0.6rem; text-align: left; }
thead th { background: #f0f2f0; position: sticky; top: 0; }
tr:nth-child(even) { background: #fafafa; }
.chat-btn {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--verde); color: white; border-radius: 50%;
  width: 58px; height: 58px; display: flex; justify-content: center; align-items: center;
  font-size: 26px; box-shadow: 0 3px 8px rgba(0,0,0,0.25); cursor: pointer;
}
.modal {
  position: fixed; inset: 0; display: flex; justify-content: center; align-items: center;
  background: rgba(0,0,0,0.35); z-index: 50;
}
.hidden { display: none; }
</style>
</head>

<body class="p-6">
<header class="flex justify-between items-center mb-6">
  <div class="flex items-center gap-3">
    <i data-lucide="activity" class="text-[var(--verde)]"></i>
    <h1 class="text-2xl font-semibold text-[var(--verde)]">CohortIQ</h1>
    <span id="nombreCohorte" class="text-gray-500 text-sm">Cohorte dinámica</span>
  </div>
  <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al panel</a>
</header>

<main class="space-y-6">
  <!-- Tarjetas de resumen -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="card text-center"><p>Pacientes</p><h3 id="nPac" class="text-xl font-bold text-[var(--verde)]">–</h3></div>
    <div class="card text-center"><p>Edad media</p><h3 id="edadMedia" class="text-xl font-bold text-[var(--verde)]">–</h3></div>
    <div class="card text-center"><p>% Controlados</p><h3 id="controlados" class="text-xl font-bold text-[var(--verde)]">–</h3></div>
    <div class="card text-center"><p>% Adherencia</p><h3 id="adherencia" class="text-xl font-bold text-[var(--verde)]">–</h3></div>
  </section>

  <!-- Gráficos -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="card">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-[var(--verde)] font-semibold">Evolución clínica (últimos 3 meses)</h2>
        <select id="variableSelect" class="border border-gray-300 rounded-md text-sm p-1">
          <option>HbA1c</option><option>TFG</option><option>IMC</option>
          <option>colesterol_total</option><option>LDL</option>
          <option>HDL</option><option>triglicéridos</option><option>creatinina</option>
        </select>
      </div>
      <canvas id="graficoCohorte" height="180"></canvas>
    </div>

    <div class="card">
      <h2 class="text-[var(--verde)] font-semibold mb-2">Uso y adherencia de medicaciones</h2>
      <canvas id="graficoMed" height="180"></canvas>
      <p id="resumenMed" class="text-gray-600 text-sm mt-3"></p>
    </div>
  </section>

  <!-- Alertas -->
  <section id="alertasContainer" class="card hidden"></section>

  <!-- Generador de gráficos personalizados -->
  <section class="card">
    <h2 class="text-[var(--verde)] font-semibold mb-2">Gráficos personalizados</h2>
    <div class="flex gap-2 mb-3">
      <input id="inputGrafico" placeholder="Ej: histograma de edad por sexo" class="flex-grow border border-gray-300 rounded-md p-2 text-sm">
      <button onclick="generarGrafico()" class="bg-[var(--verde)] text-white px-4 rounded-md">Generar</button>
    </div>
  </section>

  <!-- Tabla de pacientes -->
  <section class="card">
    <h2 class="text-[var(--verde)] font-semibold mb-3">Pacientes de la cohorte</h2>
    <div class="overflow-auto max-h-[420px] border border-gray-200 rounded-md">
      <table id="tablaPacientes" class="w-full text-sm">
        <thead><tr id="headerPacientes"></tr></thead><tbody></tbody>
      </table>
    </div>
    <div class="text-right mt-3">
      <button onclick="descargarCSV()" class="bg-[var(--verde)] text-white px-4 py-1 rounded-md text-sm">Descargar CSV completo</button>
    </div>
  </section>
</main>

<div id="modal" class="modal hidden"><div class="bg-white p-6 rounded-lg shadow-lg text-center w-[300px]"><p class="text-gray-600">Procesando solicitud...</p></div></div>
<div class="chat-btn" onclick="abrirChat()"><i data-lucide="message-circle"></i></div>

<script>
lucide.createIcons();
const supabase = window.supabase.createClient("https://tmolxeszsgkffurhrcxy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw");

// === Gráficos demo ===
const demoGrafico1={chart_type:"bar",xaxis:"sexo",yaxis:"edad_media",data:[{sexo:"Hombre",edad_media:63.2},{sexo:"Mujer",edad_media:58.4}],sql:"SELECT sexo, AVG(edad) AS edad_media FROM pacientes GROUP BY sexo;"};
const demoGrafico2={chart_type:"line",xaxis:"mes",yaxis:"HbA1c_media",data:[{mes:"Abr",HbA1c_media:7.1},{mes:"May",HbA1c_media:6.9},{mes:"Jun",HbA1c_media:6.8},{mes:"Jul",HbA1c_media:6.7},{mes:"Ago",HbA1c_media:6.9},{mes:"Sep",HbA1c_media:7.0}],sql:"SELECT mes, AVG(HbA1c) AS HbA1c_media FROM laboratorios GROUP BY mes ORDER BY mes;"};
const demoGrafico3={chart_type:"bar",xaxis:"nivel_socioeconómico",yaxis:"IMC_medio",data:[{nivel_socioeconómico:"Bajo",IMC_medio:29.3},{nivel_socioeconómico:"Medio",IMC_medio:27.6},{nivel_socioeconómico:"Alto",IMC_medio:25.9}],sql:"SELECT nivel_socioeconómico, AVG(IMC) AS IMC_medio FROM pacientes GROUP BY nivel_socioeconómico;"};

// interceptar generación de gráfico
async function generarGrafico(){
  const consulta=document.getElementById("inputGrafico").value.trim().toLowerCase();
  if(!consulta)return alert("Escribe la consulta del gráfico que quieres generar.");
  document.getElementById("modal").classList.remove("hidden");
  let demo=null;
  if(consulta.includes("edad")&&consulta.includes("sexo"))demo=demoGrafico1;
  else if(consulta.includes("hba1c")||consulta.includes("glucosa"))demo=demoGrafico2;
  else if(consulta.includes("imc")&&(consulta.includes("nivel")||consulta.includes("socio")))demo=demoGrafico3;
  if(demo){await new Promise(r=>setTimeout(r,2000));cerrarModal();mostrarGraficoCustom(demo);return;}
  try{
    const res=await fetch("https://rubaseval.app.n8n.cloud/webhook/grafico",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({consulta,cohorte:"General"})});
    const data=await res.json();cerrarModal();mostrarGraficoCustom(data);
  }catch(e){cerrarModal();alert("Error al contactar con n8n: "+e.message);}
}

function mostrarGraficoCustom(resp){
  const modal=document.createElement("div");
  modal.className="modal";
  modal.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-lg w-[90%] max-w-3xl h-[85%] flex flex-col"><div class="flex justify-between mb-2"><h3 class="font-semibold text-[var(--verde)]">Gráfico personalizado</h3><button onclick="this.closest('.modal').remove()" class="bg-[var(--verde)] text-white px-3 py-1 rounded-md text-sm">Cerrar</button></div><canvas id="graficoWebhook" class="flex-grow"></canvas><pre class="text-xs bg-gray-50 border border-gray-200 rounded-md p-2 mt-3 overflow-auto">${resp.sql||"Sin SQL"}</pre></div>`;
  document.body.appendChild(modal);
  const labels=resp.data.map(d=>d[resp.xaxis]);
  const valores=resp.data.map(d=>d[resp.yaxis]);
  new Chart(document.getElementById("graficoWebhook"),{type:resp.chart_type||"bar",data:{labels,datasets:[{label:resp.yaxis,data:valores,backgroundColor:"#4ba67d"}]},options:{plugins:{title:{display:true,text:`${resp.xaxis} vs ${resp.yaxis}`,color:"#3d7658"}},scales:{y:{beginAtZero:true}}}});
}

function cerrarModal(){document.getElementById("modal").classList.add("hidden");}
function abrirChat(){window.open("chat.html","_blank");}
</script>
</body>
</html>
