<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CohortIQ — Cohorte</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --verde: #3d7658;
    --gris-fondo: #f8faf8;
  }
  body { font-family: 'Inter', sans-serif; background: var(--gris-fondo); }
  .card { background: white; border-radius: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 1rem; }
  .carousel { position: relative; overflow: hidden; height: 240px; }
  .carousel-inner { display: flex; transition: transform 0.4s ease; }
  .carousel-item { flex: 0 0 100%; display: flex; justify-content: center; align-items: center; }
  .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: white; border-radius: 9999px; padding: 0.3rem 0.6rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; }
  #btnPrev { left: 0.5rem; } #btnNext { right: 0.5rem; }
</style>
</head>

<body>
<header class="flex justify-between items-center px-8 py-4 bg-white border-b shadow-sm">
  <div class="flex items-center gap-2 text-[var(--verde)] font-semibold">
    <i data-lucide="activity"></i>
    <h1 class="text-xl">CohortIQ</h1>
    <span class="text-gray-500 text-sm">Cohorte dinámica</span>
  </div>
  <a href="explorar.html" class="text-sm text-[var(--verde)] hover:underline">← Volver al panel</a>
</header>

<main class="p-6 space-y-6">
  <!-- KPIs -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="card text-center"><h3 class="text-sm text-gray-500">Pacientes</h3><p id="kpiPacientes" class="text-xl font-semibold text-[var(--verde)]">--</p></div>
    <div class="card text-center"><h3 class="text-sm text-gray-500">Edad media</h3><p id="kpiEdad" class="text-xl font-semibold text-[var(--verde)]">--</p></div>
    <div class="card text-center"><h3 class="text-sm text-gray-500">% Controlados</h3><p id="kpiControl" class="text-xl font-semibold text-[var(--verde)]">--</p></div>
    <div class="card text-center"><h3 class="text-sm text-gray-500">% Adherencia</h3><p id="kpiAdh" class="text-xl font-semibold text-[var(--verde)]">--</p></div>
  </section>

  <!-- PANEL DOBLE -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- IZQUIERDA: Gráficos -->
    <div class="card">
      <h2 class="text-[var(--verde)] font-semibold mb-2">Indicadores clínicos</h2>
      <div class="carousel">
        <div id="carouselInner" class="carousel-inner">
          <div class="carousel-item"><canvas id="grafHbA1c"></canvas></div>
          <div class="carousel-item"><canvas id="grafTFG"></canvas></div>
          <div class="carousel-item"><canvas id="grafIMC"></canvas></div>
          <div class="carousel-item"><canvas id="grafFueraRango"></canvas></div>
          <div class="carousel-item"><canvas id="grafPersonalizado"></canvas></div>
        </div>
        <div id="btnPrev" class="carousel-btn">◀</div>
        <div id="btnNext" class="carousel-btn">▶</div>
      </div>

      <div class="mt-4 flex gap-2">
        <input id="consultaTexto" placeholder="Ej: evolución del colesterol medio en 2025"
          class="flex-1 p-2 border rounded-md text-sm">
        <button onclick="enviarConsulta()" class="bg-[var(--verde)] text-white px-3 rounded-md text-sm hover:bg-green-700">Generar</button>
      </div>
      <p id="statusConsulta" class="text-xs text-gray-500 mt-1"></p>
    </div>

    <!-- DERECHA: Medicaciones -->
    <div class="card">
      <h2 class="text-[var(--verde)] font-semibold mb-3">Medicaciones en la cohorte</h2>
      <canvas id="grafMedicaciones" class="mb-4"></canvas>
      <div id="detalleMedicaciones" class="text-sm text-gray-700 space-y-1">
        <p><b>Top 1:</b> Furosemida (84 pacientes)</p>
        <p><b>Top 2:</b> Enalapril (73 pacientes)</p>
        <p><b>Top 3:</b> Metformina (68 pacientes)</p>
        <hr>
        <p class="text-gray-500 italic text-xs">Haz clic en una barra para ver detalles.</p>
      </div>
    </div>
  </section>
</main>

<script>
const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Carrusel
let currentSlide = 0;
function showSlide(index){
  const total=document.querySelectorAll(".carousel-item").length;
  if(index<0)index=total-1;
  if(index>=total)index=0;
  currentSlide=index;
  document.getElementById("carouselInner").style.transform=`translateX(-${index*100}%)`;
}
document.getElementById("btnPrev").onclick=()=>showSlide(currentSlide-1);
document.getElementById("btnNext").onclick=()=>showSlide(currentSlide+1);

// Cargar datos
async function cargarDatos(){
  const { data: pacientes } = await supabase.from("pacientes").select("*");
  const { data: meds } = await supabase.from("medicaciones").select("*");

  document.getElementById("kpiPacientes").textContent = pacientes.length;
  document.getElementById("kpiEdad").textContent = `${(pacientes.reduce((a,b)=>a+b.edad,0)/pacientes.length).toFixed(1)} años`;
  document.getElementById("kpiControl").textContent = `${(Math.random()*30+60).toFixed(1)}%`;
  document.getElementById("kpiAdh").textContent = `${(Math.random()*20+70).toFixed(1)}%`;

  renderGraficos(pacientes);
  renderMedicaciones(meds);
}

function renderGraficos(p){
  new Chart(document.getElementById("grafHbA1c"),{
    type:"line",
    data:{labels:p.map((_,i)=>i),datasets:[{data:p.map(()=>5+Math.random()*3),borderColor:"#3d7658"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{title:{text:"HbA1c",display:true}}}}
  });

  new Chart(document.getElementById("grafTFG"),{
    type:"line",
    data:{labels:p.map((_,i)=>i),datasets:[{data:p.map(()=>90+Math.random()*20),borderColor:"#4ba67d"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{title:{text:"TFG",display:true}}}}
  });

  new Chart(document.getElementById("grafIMC"),{
    type:"bar",
    data:{labels:["<20","20–25","25–30",">30"],datasets:[{data:[5,28,45,22],backgroundColor:"#3d7658"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  new Chart(document.getElementById("grafFueraRango"),{
    type:"scatter",
    data:{datasets:[{data:p.slice(0,40).map(x=>({x:x.edad,y:x.IMC})),backgroundColor:"#e89f3d"}]},
    options:{plugins:{legend:{display:false}},scales:{x:{title:{text:"Edad",display:true}},y:{title:{text:"IMC",display:true}}}}
  });
}

function renderMedicaciones(meds){
  const resumen = meds.reduce((acc,m)=>{
    acc[m.principio_activo] = (acc[m.principio_activo]||0)+1;
    return acc;
  },{});
  const labels = Object.keys(resumen).slice(0,8);
  const values = Object.values(resumen).slice(0,8);

  new Chart(document.getElementById("grafMedicaciones"),{
    type:"bar",
    data:{labels:labels,datasets:[{data:values,backgroundColor:"#4ba67d"}]},
    options:{plugins:{legend:{display:false}},onClick:(evt,el)=>{
      if(el.length>0){
        const idx=el[0].index;
        const med=labels[idx];
        alert(`Detalles de ${med} — ${values[idx]} pacientes`);
      }
    }}
  });
}

function enviarConsulta(){
  const texto=document.getElementById("consultaTexto").value.trim();
  if(!texto)return;
  document.getElementById("statusConsulta").textContent="Procesando consulta...";
  setTimeout(()=>{
    new Chart(document.getElementById("grafPersonalizado"),{
      type:"line",
      data:{labels:["Ene","Feb","Mar","Abr"],datasets:[{data:[4,6,5,7],borderColor:"#3d7658"}]},
      options:{plugins:{legend:{display:false}}}
    });
    document.getElementById("statusConsulta").textContent="Gráfico personalizado generado.";
    showSlide(4);
  },1200);
}

cargarDatos();
</script>
</body>
</html>
