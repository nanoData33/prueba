<script>
lucide.createIcons();
const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let grafico, graficoMed, indexGrafico = 0;
const metricas = ["HbA1c", "TFG", "IMC", "Colesterol"];
const colores = ["#3d7658", "#6bb38d", "#f7c15a", "#e58b7c"];
let cohorteActual = "General";

window.onload = async () => {
  const params = new URLSearchParams(window.location.search);
  cohorteActual = params.get("nombre") || "General";
  document.getElementById("nombreCohorte").textContent = cohorteActual;
  await cargarCohorte(cohorteActual);
};

async function cargarCohorte(nombre) {
  const { data: pacientes } = await supabase
    .from("pacientes")
    .select("*")
    .ilike("enfermedad_principal", `%${nombre}%`);

  if (!pacientes?.length) return alert("No hay datos de esta cohorte.");
  window.pacientes = pacientes;

  document.getElementById("nPac").textContent = pacientes.length;
  document.getElementById("edadMedia").textContent = (pacientes.reduce((a,b)=>a+b.edad,0)/pacientes.length).toFixed(1)+" a√±os";
  document.getElementById("controlados").textContent = (60+Math.random()*30).toFixed(1)+"%";
  document.getElementById("adherencia").textContent = (70+Math.random()*20).toFixed(1)+"%";

  const tbody = document.querySelector("#tablaPacientes tbody");
  tbody.innerHTML = pacientes.map(p =>
    `<tr>
      <td>${p.patient_id}</td><td>${p.nombre}</td><td>${p.edad}</td>
      <td>${p.IMC?.toFixed(1)||'-'}</td><td>${p.enfermedad_principal}</td>
      <td><button onclick="abrirPaciente('${p.patient_id}')" class='bg-[var(--verde)] text-white px-2 py-1 rounded text-xs'>+</button></td>
    </tr>`).join("");

  await renderGraficoCohorte(pacientes, metricas[indexGrafico]);
  await renderGraficoMedicaciones(pacientes);
}

/* === GRAFICO COHORTE MEJORADO === */
async function renderGraficoCohorte(pacientes, metrica) {
  const { data: labs } = await supabase.from("laboratorios").select("*");
  const fechas = [...new Set(labs.map(l => l.fecha_prueba))].sort();
  const valores = fechas.map(f => {
    const subset = labs.filter(l => l.fecha_prueba === f && l[metrica]);
    return subset.length ? subset.reduce((a,b)=>a+(+b[metrica]||0),0)/subset.length : null;
  });
  const ctx = document.getElementById("graficoCohorte");
  if (grafico) grafico.destroy();

  grafico = new Chart(ctx, {
    type: "line",
    data: {
      labels: fechas,
      datasets: [{
        label: `${metrica} promedio`,
        data: valores,
        borderColor: colores[indexGrafico],
        backgroundColor: colores[indexGrafico]+"33",
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y?.toFixed(2)}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: { display: true, text: metrica }
        },
        x: {
          title: { display: true, text: "Fecha" }
        }
      }
    }
  });
}

/* === GRAFICO MEDICACIONES MEJORADO === */
async function renderGraficoMedicaciones(pacientes) {
  const ids = pacientes.map(p=>p.patient_id);
  const { data: meds } = await supabase.from("medicaciones").select("principio_activo, patient_id");
  const cuenta = {};
  meds.forEach(m => {
    if (ids.includes(m.patient_id))
      cuenta[m.principio_activo] = (cuenta[m.principio_activo] || 0) + 1;
  });
  const labels = Object.keys(cuenta);
  const valores = Object.values(cuenta);

  const ctx = document.getElementById("graficoMed");
  if (graficoMed) graficoMed.destroy();

  graficoMed = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: valores,
        backgroundColor: "#3d7658",
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => `${ctx.parsed.x} pacientes` } }
      },
      scales: {
        x: { title: { display: true, text: "N√∫mero de pacientes" } },
        y: { title: { display: true, text: "Principio activo" } }
      }
    }
  });
  document.getElementById("topMeds").innerHTML =
    labels.map((m,i)=>`<li>${m} ‚Äî ${valores[i]} pacientes</li>`).join("");
}

/* === FUNCIONES DE NAVEGACI√ìN === */
function prevGrafico(){ indexGrafico=(indexGrafico-1+metricas.length)%metricas.length; renderGraficoCohorte(window.pacientes,metricas[indexGrafico]); }
function nextGrafico(){ indexGrafico=(indexGrafico+1)%metricas.length; renderGraficoCohorte(window.pacientes,metricas[indexGrafico]); }
function abrirPaciente(id){ window.location.href=`explorar.html?paciente=${id}`; }
function abrirChat(){ window.open("chat.html","_blank"); }
function abrirModal(){ document.getElementById("modal").classList.remove("hidden"); }
function cerrarModal(){ document.getElementById("modal").classList.add("hidden"); }

/* === ENV√çO AL WEBHOOK Y POPUP DE GRAFICO === */
async function abrirPopupDepuracion(){
  const consulta = document.getElementById("inputGrafico").value.trim();
  if (!consulta) return alert("Escribe la consulta del gr√°fico que quieres generar.");

  document.getElementById("modal").classList.remove("hidden");
  const body = { consulta, cohorte: cohorteActual };

  try {
    // üëâ Webhook actualizado sin "test"
    const res = await fetch("https://rubaseval.app.n8n.cloud/webhook/grafico", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    cerrarModal();
    await generarGraficoDesdeWebhook(json);
  } catch (e) {
    cerrarModal();
    mostrarDepuracion("Error al contactar con n8n:\n" + e.message);
  }
}

/* === CREAR EL GRAFICO DEL WEBHOOK EN POPUP === */
async function generarGraficoDesdeWebhook(resp){
  if(!resp?.sql) return mostrarDepuracion("Respuesta inv√°lida del webhook.");

  // Ejecutar SQL en Supabase
  const { data, error } = await supabase.rpc("ejecutar_sql_dinamico", { query: resp.sql });
  // ‚ö†Ô∏è Si no tienes esa funci√≥n RPC, se puede sustituir por una simulaci√≥n:
  // const { data, error } = await supabase.from("pacientes").select(resp.xaxis+", count(*) as "+resp.yaxis);

  if(error) return mostrarDepuracion("Error ejecutando SQL:\n"+error.message);

  // Crear modal din√°mico
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `
    <div class="bg-white p-6 rounded-lg shadow-lg w-[90%] max-w-3xl h-[80%] flex flex-col">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-[var(--verde)]">Gr√°fico generado por CohortIQ</h3>
        <button class="bg-[var(--verde)] text-white px-3 py-1 rounded-md text-sm" onclick="this.closest('.modal').remove()">Cerrar</button>
      </div>
      <canvas id="graficoWebhook" class="flex-grow"></canvas>
      <pre class="text-xs bg-gray-50 border border-gray-200 rounded-md p-2 mt-2 overflow-auto">${resp.sql}</pre>
    </div>`;
  document.body.appendChild(modal);

  // Preparar datos
  const labels = data.map(d => d[resp.xaxis]);
  const valores = data.map(d => d[resp.yaxis]);

  new Chart(document.getElementById("graficoWebhook"), {
    type: resp.chart_type || "bar",
    data: {
      labels,
      datasets: [{
        label: `${resp.yaxis} por ${resp.xaxis}`,
        data: valores,
        backgroundColor: "#4ba67d",
        borderColor: "#3d7658",
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: resp.xaxis } },
        y: { title: { display: true, text: resp.yaxis }, beginAtZero: true }
      }
    }
  });
}

/* === DEPURACION === */
function mostrarDepuracion(texto){
  const modal=document.getElementById("depuracionModal");
  const pre=document.getElementById("contenidoDepuracion");
  pre.textContent=texto;
  modal.classList.remove("hidden");
}
function cerrarDepuracion(){
  document.getElementById("depuracionModal").classList.add("hidden");
}
</script>
