<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CohortIQ ‚Äî Cohorte Detallada</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --verde: #2b7a58;
      --verde-claro: #4aba84;
      --gris-fondo: #f6f7f6;
    }
    body { font-family: "Inter", sans-serif; background-color: var(--gris-fondo); }
    header { background:white; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .panel { background:white; border-radius:0.9rem; padding:1.5rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .btn { background:var(--verde); color:white; padding:0.6rem 1rem; border-radius:0.4rem; font-weight:500; transition:0.2s; }
    .btn:hover { background:var(--verde-claro); }
  </style>
</head>

<body>
  <header class="flex justify-between items-center px-8 py-4">
    <div class="flex items-center gap-2">
      <i data-lucide="users" class="text-[var(--verde)]"></i>
      <h1 id="tituloCohorte" class="text-xl font-semibold text-[var(--verde)]">Cohorte</h1>
    </div>
    <a href="index.html" class="text-sm text-[var(--verde)] hover:underline">‚Üê Volver al panel</a>
  </header>

  <main class="p-8 grid grid-cols-1 xl:grid-cols-3 gap-8">
    
    <!-- RESUMEN GENERAL -->
    <section class="col-span-1 panel">
      <h2 class="font-semibold text-[var(--verde)] mb-4 flex items-center gap-2">
        <i data-lucide="activity"></i> Resumen General
      </h2>
      <div id="resumen" class="space-y-2 text-sm text-gray-600">Cargando...</div>

      <div class="mt-5 flex flex-col gap-2">
        <button class="btn" onclick="generarInforme()">üìÑ Generar informe PDF</button>
        <button class="btn bg-amber-600 hover:bg-amber-700" onclick="enviarAlertas()">‚ö†Ô∏è Enviar alerta n8n</button>
        <button class="btn bg-sky-700 hover:bg-sky-800" onclick="exportarCohorte()">üì§ Exportar a investigaci√≥n</button>
      </div>
    </section>

    <!-- TENDENCIAS Y TRATAMIENTOS -->
    <section class="col-span-2 grid grid-cols-2 gap-6">
      <div class="panel">
        <h3 class="font-semibold text-[var(--verde)] mb-2">Evoluci√≥n cl√≠nica media</h3>
        <canvas id="grafTendencias" height="160"></canvas>
      </div>
      <div class="panel">
        <h3 class="font-semibold text-[var(--verde)] mb-2">Tratamientos m√°s usados</h3>
        <canvas id="grafMedicaciones" height="160"></canvas>
      </div>

      <div class="panel col-span-2">
        <h3 class="font-semibold text-[var(--verde)] mb-2">Pacientes con valores fuera de rango</h3>
        <div id="listaRiesgo" class="text-sm text-gray-700 max-h-[40vh] overflow-y-auto"></div>
      </div>
    </section>
  </main>

  <script>
    lucide.createIcons();

    const supabaseUrl = "https://tmolxeszsgkffurhrcxy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const params = new URLSearchParams(window.location.search);
    const nombreCohorte = decodeURIComponent(params.get("nombre"));
    document.getElementById("tituloCohorte").textContent = `Cohorte: ${nombreCohorte}`;

    async function cargarCohorte() {
      // Datos principales
      const { data: pacientes } = await supabase.from("pacientes").select("*").eq("enfermedad_principal", nombreCohorte);
      const ids = pacientes.map(p => p.patient_id);
      const [labs, meds] = await Promise.all([
        supabase.from("laboratorios").select("*").in("patient_id", ids),
        supabase.from("medicaciones").select("*").in("patient_id", ids)
      ]);

      // Resumen general
      const edadMedia = (pacientes.reduce((a,b)=>a+(b.edad||0),0)/pacientes.length).toFixed(1);
      const imcMedio = (pacientes.reduce((a,b)=>a+(b.IMC||0),0)/pacientes.length).toFixed(1);
      const controlados = labs.data.filter(l=>l.HbA1c<7 && l.TFG>60).length;
      document.getElementById("resumen").innerHTML = `
        <p><b>Pacientes:</b> ${pacientes.length}</p>
        <p><b>Edad media:</b> ${edadMedia} a√±os</p>
        <p><b>IMC medio:</b> ${imcMedio}</p>
        <p><b>% Controlados:</b> ${((controlados/labs.data.length)*100||0).toFixed(1)}%</p>
      `;

      // Gr√°fico 1: Tendencias cl√≠nicas
      const fechas = [...new Set(labs.data.map(l=>l.fecha_prueba))].sort();
      const promedioHbA1c = fechas.map(f=>{
        const vals = labs.data.filter(l=>l.fecha_prueba===f).map(l=>l.HbA1c||0);
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      });
      const promedioTFG = fechas.map(f=>{
        const vals = labs.data.filter(l=>l.fecha_prueba===f).map(l=>l.TFG||0);
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      });

      new Chart(document.getElementById("grafTendencias"),{
        type:'line',
        data:{ labels:fechas, datasets:[
          {label:'HbA1c', data:promedioHbA1c, borderColor:'#4aba84'},
          {label:'TFG', data:promedioTFG, borderColor:'#2b7a58'}
        ]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:false }}}
      });

      // Gr√°fico 2: Medicaciones m√°s usadas
      const freq = {};
      meds.data.forEach(m=>{ freq[m.principio_activo]=(freq[m.principio_activo]||0)+1; });
      const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,8);
      new Chart(document.getElementById("grafMedicaciones"),{
        type:'bar',
        data:{ labels:top.map(x=>x[0]), datasets:[{label:'Pacientes tratados', data:top.map(x=>x[1]), backgroundColor:'#4aba84'}]},
        options:{indexAxis:'y', scales:{x:{beginAtZero:true}}}
      });

      // Pacientes con riesgo
      const enRiesgo = labs.data.filter(l=>l.HbA1c>7.5 || l.TFG<60);
      const cont = document.getElementById("listaRiesgo");
      cont.innerHTML = enRiesgo.length ? 
        enRiesgo.map(r=>`<p>üßç ${r.patient_id} ‚Äî HbA1c: ${r.HbA1c}, TFG: ${r.TFG}</p>`).join("") :
        "<p class='text-gray-400 italic'>Ning√∫n paciente en riesgo</p>";
    }

    // === FLUJOS N8N ===
    function generarInforme() {
      fetch("https://your-n8n-url.com/webhook/informe_cohorte",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ cohorte:nombreCohorte })
      }).then(()=>alert("Informe enviado para generaci√≥n"));
    }

    function enviarAlertas() {
      fetch("https://your-n8n-url.com/webhook/alerta_paciente",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ cohorte:nombreCohorte })
      }).then(()=>alert("Alertas enviadas"));
    }

    function exportarCohorte() {
      fetch("https://your-n8n-url.com/webhook/exportar_cohorte",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ cohorte:nombreCohorte })
      }).then(()=>alert("Cohorte exportada a investigaci√≥n"));
    }

    cargarCohorte();
  </script>
</body>
</html>
